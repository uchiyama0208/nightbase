module.exports=[12095,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);a.i(70396);var e=a.i(73727);async function f(a){let b=a.get("storeName"),f=a.get("profileDisplayName")??null,g=await (0,c.createServerClient)(),{data:{user:h}}=await g.auth.getUser();if(!h)throw Error("User not authenticated");if(!b)throw Error("Store name is required");let{data:i,error:j}=await g.from("stores").insert({name:b}).select().single();if(j)throw console.error("Error creating store:",j),Error("Failed to create store");let{data:k,error:l}=await g.from("profiles").insert({user_id:h.id,store_id:i.id,role:"admin",display_name:f&&f.trim().length>0?f.trim():"Admin"}).select().single();if(l||!k)throw console.error("Error creating profile:",l),await g.from("stores").delete().eq("id",i.id),Error("Failed to create profile");let{error:m}=await g.from("users").upsert({id:h.id,email:h.email??null,current_profile_id:k.id},{onConflict:"id"});m&&console.error("Error setting current_profile_id on users:",m),(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/dashboard"),(0,d.revalidatePath)("/app/(main)","layout"),(0,e.redirect)("/app/settings")}async function g(){let a=await (0,c.createServerClient)();await a.auth.signOut(),(0,e.redirect)("/login")}async function h(a){let b="on"===a.get("showBreakColumns"),e="on"===a.get("tabletTimecardEnabled"),f=a.get("tabletAcceptanceStartTime"),g=a.get("tabletAcceptanceEndTime"),h=a.getAll("tabletAllowedRoles"),i=a.get("tabletTheme"),j="on"===a.get("locationCheckEnabled"),k=a.get("latitude")?parseFloat(a.get("latitude")):null,l=a.get("longitude")?parseFloat(a.get("longitude")):null,m=a.get("locationRadius")?parseInt(a.get("locationRadius")):50,n="on"===a.get("timeRoundingEnabled"),o=a.get("timeRoundingMethod"),p=a.get("timeRoundingMinutes")?parseInt(a.get("timeRoundingMinutes")):15,q="on"===a.get("autoClockoutEnabled"),r=await (0,c.createServerClient)(),{data:{user:s}}=await r.auth.getUser();if(!s)throw Error("User not authenticated");let{data:t,error:u}=await r.from("profiles").select("store_id").eq("user_id",s.id).maybeSingle();if(u)throw console.error("Error fetching profile for timecard settings:",u),Error("Failed to fetch profile for timecard settings");if(!t?.store_id)throw Error("Store not found for current user");let v={show_break_columns:b,tablet_timecard_enabled:e,location_check_enabled:j,latitude:k,longitude:l,location_radius:m,time_rounding_enabled:n,time_rounding_method:o||"round",time_rounding_minutes:p,auto_clockout_enabled:q};e&&(v.tablet_acceptance_start_time=f||null,v.tablet_acceptance_end_time=g||null,v.tablet_allowed_roles=h.length>0?h:["staff","cast"],v.tablet_theme=i||"light");let{error:w}=await r.from("stores").update(v).eq("id",t.store_id);if(w)throw console.error("Error updating store timecard settings:",w),Error("Failed to update timecard settings");(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/settings/timecard"),(0,d.revalidatePath)("/app/timecard"),(0,d.revalidatePath)(`/tablet/timecard/${t.store_id}`)}async function i(a){let b="on"===a.get("show_dashboard"),f="on"===a.get("show_attendance"),g="on"===a.get("show_timecard"),h="on"===a.get("show_users"),i="on"===a.get("show_roles"),j=await (0,c.createServerClient)(),{data:{user:k}}=await j.auth.getUser();if(!k)throw Error("User not authenticated");let{data:l,error:m}=await j.from("profiles").select("store_id").eq("user_id",k.id).maybeSingle();if(m)throw console.error("Error fetching profile for feature settings:",m),Error("Failed to fetch profile for feature settings");if(!l?.store_id)throw Error("Store not found for current user");let{error:n}=await j.from("stores").update({show_dashboard:b,show_attendance:f,show_timecard:g,show_users:h,show_roles:i}).eq("id",l.store_id);if(n)throw console.error("Error updating feature settings:",n),Error("Failed to update feature settings");(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/dashboard"),(0,d.revalidatePath)("/app/attendance"),(0,d.revalidatePath)("/app/users"),(0,d.revalidatePath)("/app/roles"),(0,d.revalidatePath)("/app/(main)","layout"),(0,d.revalidatePath)("/app/features"),(0,e.redirect)("/app/features")}async function j(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();f||(0,e.redirect)("/login");let{data:g}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();g?.current_profile_id||(0,e.redirect)("/app/me");let{data:h}=await b.from("profiles").select("store_id, role").eq("id",g.current_profile_id).maybeSingle();if(h&&h.store_id||(0,e.redirect)("/app/me"),"staff"!==h.role)throw Error(`Unauthorized: Current role is '${h.role}'`);let i=a.get("name"),j=a.get("business_start_time"),k=a.get("business_end_time"),l=a.get("day_switch_time"),m=a.get("industry"),n=a.get("prefecture"),o=a.getAll("closed_days"),p="on"===a.get("allow_join_requests");await b.from("stores").update({name:i,business_start_time:j||null,business_end_time:k||null,day_switch_time:l||null,industry:m||null,prefecture:n||null,closed_days:o.length>0?o:null,allow_join_requests:p,updated_at:new Date().toISOString()}).eq("id",h.store_id),(0,d.revalidatePath)("/app/settings/store"),(0,e.redirect)("/app/settings/store")}async function k(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("User not authenticated");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile found");let{error:g}=await b.from("profiles").update({theme:a}).eq("id",f.current_profile_id);if(g)throw console.error("Error updating theme:",g),Error("Failed to update theme");(0,d.revalidatePath)("/","layout")}async function l(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();return e&&e.store_id?"staff"!==e.role?{redirect:"/app/timecard"}:{success:!0}:{redirect:"/app/me"}}async function m(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:f}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile found");let{data:g}=await a.from("profiles").select("store_id, role").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("No store found");if("staff"!==g.role)throw Error(`Insufficient permissions: Current role is '${g.role}'`);let{error:h}=await a.from("stores").delete().eq("id",g.store_id);if(h)throw console.error("Error deleting store:",h),Error("Failed to delete store");await a.from("users").update({current_profile_id:null}).eq("id",b.id),(0,d.revalidatePath)("/","layout"),(0,e.redirect)("/app/me")}async function n(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile");let{data:g}=await b.from("profiles").select("store_id, role").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("No store");if("staff"!==g.role)throw Error(`Unauthorized: Current role is '${g.role}'`);let h=a.get("file");if(!h)throw Error("ファイルが選択されていません");let i=h.name.split(".").pop(),j=`store-${g.store_id}-${Date.now()}.${i}`,k=`store-icons/${j}`,{error:l}=await b.storage.from("avatars").upload(k,h);if(l)throw Error(`アップロードに失敗しました: ${l.message}`);let{data:{publicUrl:m}}=b.storage.from("avatars").getPublicUrl(k),{error:n}=await b.from("stores").update({icon_url:m}).eq("id",g.store_id);if(n)throw Error(`更新に失敗しました: ${n.message}`);return(0,d.revalidatePath)("/app/settings/store"),{success:!0,publicUrl:m}}async function o(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:e}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!e?.current_profile_id)throw Error("No profile");let{data:f}=await a.from("profiles").select("store_id, role").eq("id",e.current_profile_id).maybeSingle();if(!f?.store_id)throw Error("No store");if("staff"!==f.role)throw Error(`Unauthorized: Current role is '${f.role}'`);let{data:g}=await a.from("stores").select("icon_url").eq("id",f.store_id).single();if(g?.icon_url){let b=new URL(g.icon_url),c=`store-icons/${b.pathname.split("/").pop()}`;await a.storage.from("avatars").remove([c])}let{error:h}=await a.from("stores").update({icon_url:null}).eq("id",f.store_id);if(h)throw Error(`削除に失敗しました: ${h.message}`);return(0,d.revalidatePath)("/app/settings/store"),{success:!0}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(f,"405c7cfb7acf03ff32fbbb80b7519d602d9c21f819",null),(0,b.registerServerReference)(g,"00642b6ba2fcfa7262834fb54abfd4a10b7fd12d56",null),(0,b.registerServerReference)(h,"40341d408f028c7c9e09e5718db53f79f7665ac28c",null),(0,b.registerServerReference)(i,"40fa5639615fcc2f608746959cf859a32c49629715",null),(0,b.registerServerReference)(j,"405876b122190683f26917671ae7068209f3aa4158",null),(0,b.registerServerReference)(k,"40627c04ddfab389b3c9a4913a69a6119f43db382a",null),(0,b.registerServerReference)(l,"005003103cf9137765c8b83fa0bcc8d85ef626e4fa",null),(0,b.registerServerReference)(m,"00a3ece0f08af191db378518d182c60ae58e5644ab",null),(0,b.registerServerReference)(n,"401480709320f02adfc2c53fe10d5e53c5f50c595f",null),(0,b.registerServerReference)(o,"00d692a8991a77d14a953f671fadf7ca43ce78a0e6",null),a.s(["createStore",()=>f,"deleteStore",()=>m,"deleteStoreIcon",()=>o,"getSettingsData",()=>l,"signOut",()=>g,"updateFeatureSettings",()=>i,"updateStore",()=>j,"updateTheme",()=>k,"updateTimecardSettings",()=>h,"uploadStoreIcon",()=>n])},73918,a=>{"use strict";var b=a.i(93662),c=a.i(56793);function d(){let{supabaseUrl:a}=(0,c.getSupabaseConfig)(),d=(0,c.ensureEnv)("SUPABASE_SERVICE_ROLE_KEY",process.env.SUPABASE_SERVICE_ROLE_KEY);return(0,b.createClient)(a,d,{auth:{persistSession:!1,autoRefreshToken:!1},global:{fetch}})}a.s(["createServiceRoleClient",()=>d])},54799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},45861,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);async function e(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).single();if(!d?.current_profile_id)throw Error("No profile found");let{data:e}=await a.from("profiles").select("store_id").eq("id",d.current_profile_id).single();if(!e?.store_id)throw Error("No store found");return e.store_id}async function f(a){let b=await (0,c.createServerClient)(),f=await e(),{error:g}=await b.from("store_roles").insert({store_id:f,name:a.name,permissions:a.permissions});if(g)throw Error(g.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function g(a,b){let f=await (0,c.createServerClient)(),g=await e(),{data:h,error:i}=await f.from("store_roles").select("is_system_role").eq("id",a).eq("store_id",g).single();if(i||!h)throw Error("Role not found");if(h.is_system_role)throw Error("システムロールは変更できません");let{error:j}=await f.from("store_roles").update({name:b.name,permissions:b.permissions}).eq("id",a).eq("store_id",g);if(j)throw Error(j.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function h(a){let b=await (0,c.createServerClient)(),f=await e(),{data:g,error:h}=await b.from("store_roles").select("is_system_role").eq("id",a).eq("store_id",f).single();if(h||!g)throw Error("Role not found");if(g.is_system_role)throw Error("システムロールは削除できません");let{error:i}=await b.from("store_roles").delete().eq("id",a).eq("store_id",f);if(i)throw Error(i.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function i(a,b){let f=await (0,c.createServerClient)(),g=await e(),{data:h}=await f.from("profiles").select("store_id").eq("id",a).single();if(!h||h.store_id!==g)throw Error("Invalid profile");let{error:i}=await f.from("profiles").update({role_id:b}).eq("id",a);if(i)throw Error(i.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function j(a){let b=await (0,c.createServerClient)();a||(a=await e());let{data:d,error:f}=await b.from("store_roles").select("*").eq("store_id",a).order("name");return f?(console.error("Error fetching roles:",f),[]):d}async function k(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};let f=e.stores;if(f&&!1===f.show_roles||"staff"!==e.role)return{redirect:"/app/timecard"};let[g,h]=await Promise.all([a.from("store_roles").select("*").eq("store_id",e.store_id).order("created_at",{ascending:!0}),a.from("profiles").select("id, display_name, real_name, role_id, role").eq("store_id",e.store_id)]),i=g.data,j=g.error,k=h.data,l=h.error;if(j)throw console.error("Error fetching roles:",j),Error(j.message);return l&&console.error("Error fetching profiles:",l),{data:{roles:i||[],profiles:k||[]}}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k]),(0,b.registerServerReference)(f,"4051358d725b4044b4fdbd74318bae0cb8a8202223",null),(0,b.registerServerReference)(g,"6063814e7fe3c93c0a64c2da9f1839dde3930ad582",null),(0,b.registerServerReference)(h,"404e99b8a0847028f660fbc984b5dd6745e3b9c778",null),(0,b.registerServerReference)(i,"60211aeb80c05ed8abf26656abe964d684267a3d74",null),(0,b.registerServerReference)(j,"406043f51f142c0dd818afbb66f0171427e7776683",null),(0,b.registerServerReference)(k,"00a232eb085a0951373733706b35c0c0ea07607aa5",null),a.s(["assignRole",()=>i,"createRole",()=>f,"deleteRole",()=>h,"getRoles",()=>j,"getRolesData",()=>k,"updateRole",()=>g])},40041,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558),e=a.i(54799),f=a.i(45861);async function g(a,b){let d=await (0,c.createServerClient)();if(!b){let{data:{user:a}}=await d.auth.getUser();if(!a)return[];let{data:c}=await d.from("users").select("current_profile_id").eq("id",a.id).maybeSingle();if(!c?.current_profile_id)return[];let{data:e}=await d.from("profiles").select("store_id").eq("id",c.current_profile_id).maybeSingle();if(!e?.store_id)return[];b=e.store_id}let e=d.from("profiles").select(`
            id,
            invite_token,
            store_id,
            role,
            invite_status,
            invite_expires_at,
            created_at,
            display_name,
            avatar_url
        `).eq("store_id",b).in("invite_status",["pending","accepted","canceled"]);a?.status&&(e=e.eq("invite_status",a.status)),a?.status==="pending"&&(e=e.not("invite_token","is",null).not("invite_expires_at","is",null)),a?.role&&(e=e.eq("role",a.role));let{data:f,error:g}=await e;if(g)return console.error("Error fetching invitations:",g),[];let h=f.filter(a=>"pending"!==a.invite_status||!!a.invite_expires_at).map(a=>({id:a.id,token:a.id,store_id:a.store_id,profile_id:a.id,role_id:null,status:a.invite_status,expires_at:a.invite_expires_at,created_at:a.created_at,profile:{display_name:a.display_name,avatar_url:a.avatar_url,role:a.role}}));if(a?.search){let b=a.search.toLowerCase();h=h.filter(a=>(a.profile?.display_name||"").toLowerCase().includes(b))}return h}async function h(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)return{success:!1,error:"Unauthorized"};let e=await k(a);if(!e)return{success:!1,error:"Invitation not found"};let{error:f}=await b.from("profiles").update({user_id:d.id,invite_status:"accepted",invite_token:null,invite_expires_at:null}).eq("id",e.profile_id);return f?(console.error("Error accepting invitation:",f),{success:!1,error:f.message}):{success:!0}}async function i(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();if(!f)throw Error("Unauthorized");let{data:g}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!g?.current_profile_id)throw Error("No profile found");let{data:h}=await b.from("profiles").select("store_id").eq("id",g.current_profile_id).maybeSingle();if(!h?.store_id)throw Error("No store found");let i=new Date;i.setDate(i.getDate()+a.expiresInDays);let j=null;a.password&&(j=e.default.createHash("sha256").update(a.password).digest("hex"));let{data:k,error:l}=await b.from("profiles").update({invite_status:"pending",invite_expires_at:i.toISOString(),invite_password_hash:j,role_id:a.roleId||null}).eq("id",a.profileId).select().single();if(l)throw console.error("Error creating invitation:",l),Error("Failed to create invitation");return(0,d.revalidatePath)("/app/invitations"),{success:!0,invitation:{id:k.id,token:k.id,store_id:k.store_id,profile_id:k.id,role_id:null,status:k.invite_status,expires_at:k.invite_expires_at,created_at:new Date().toISOString(),profile:{display_name:k.display_name,avatar_url:k.avatar_url,role:k.role}}}}async function j(a){let b=await (0,c.createServerClient)(),{error:e}=await b.from("profiles").update({invite_status:"canceled",invite_token:null,invite_expires_at:null}).eq("id",a);if(e)throw console.error("Error canceling invitation:",e),Error("Failed to cancel invitation");return(0,d.revalidatePath)("/app/invitations"),{success:!0}}async function k(a){let b=await (0,c.createServerClient)(),{data:d,error:e}=await b.rpc("get_profile_by_id_for_invite",{lookup_id:a});if(e||!d||0===d.length)return null;let f=d[0];return{id:f.id,token:a,store_id:f.store_id,profile_id:f.id,role_id:null,status:f.invite_status,expires_at:f.invite_expires_at,created_at:new Date().toISOString(),password_hash:f.invite_password_hash,store_name:f.store_name,profile_name:f.profile_name,has_password:!!f.invite_password_hash}}async function l(a){let b=await (0,c.createServerClient)();if(!a){let{data:{user:c}}=await b.auth.getUser();if(!c)return[];let{data:d}=await b.from("users").select("current_profile_id").eq("id",c.id).maybeSingle();if(!d?.current_profile_id)return[];let{data:e}=await b.from("profiles").select("store_id").eq("id",d.current_profile_id).maybeSingle();if(!e?.store_id)return[];a=e.store_id}let{data:d}=await b.from("profiles").select("id, display_name, role, avatar_url").eq("store_id",a).is("user_id",null);return d||[]}async function m(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};if("staff"!==e.role)return{redirect:"/app/timecard"};let h=e.store_id,[i,j,k,m]=await Promise.all([g(void 0,h),l(h),(0,f.getRoles)(h),a.from("profiles").select("id, display_name, real_name, role, created_at, approval_status").eq("store_id",h).eq("approval_status","pending").order("created_at",{ascending:!1}).then(a=>a.data||[])]);return{data:{invitations:i,uninvitedProfiles:j,roles:k,joinRequestsCount:m.length,joinRequests:m}}}async function n(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("store_id, role").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};if("staff"!==e.role)return{redirect:"/app/timecard"};let{data:f}=await a.from("profiles").select("id, display_name, real_name, role, created_at, approval_status").eq("store_id",e.store_id).eq("approval_status","pending").order("created_at",{ascending:!1});return{data:{joinRequests:f||[]}}}(0,a.i(13095).ensureServerEntryExports)([g,h,i,j,k,l,m,n]),(0,b.registerServerReference)(g,"60098d0194cb419a6fd3cf8152bc46b394969a1e7d",null),(0,b.registerServerReference)(h,"40d281ed84b38ac668808ba72195ebb5e55f757c52",null),(0,b.registerServerReference)(i,"407f73d041bbeb8a449b1a11854978deb1f2bd26db",null),(0,b.registerServerReference)(j,"40c6ac2758dfc3a203b0445eadd0044237a7643d08",null),(0,b.registerServerReference)(k,"40c628f1df5e654f322ec7aa92c201a2ef9b13090c",null),(0,b.registerServerReference)(l,"401b9edc6a21bc5fed5e321d79818fa8a31ed39a51",null),(0,b.registerServerReference)(m,"00d9e4a5cc4e76c5250a3795b040d5e078b703757f",null),(0,b.registerServerReference)(n,"00af8e2dc2f7222e26f0f54a39bfb791519379a9a2",null),a.s(["acceptInvitation",()=>h,"cancelInvitation",()=>j,"createInvitation",()=>i,"getInvitationByToken",()=>k,"getInvitations",()=>g,"getInvitationsData",()=>m,"getJoinRequestsData",()=>n,"getUninvitedProfiles",()=>l])},20412,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);async function e(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(console.log("[getMenus] user:",b?.id),!b)return[];let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(console.log("[getMenus] appUser:",d),!d?.current_profile_id)return[];let{data:e}=await a.from("profiles").select("store_id").eq("id",d.current_profile_id).maybeSingle();if(console.log("[getMenus] currentProfile:",e),!e?.store_id)return[];let{data:f,error:g}=await a.from("menus").select("*").eq("store_id",e.store_id).order("category",{ascending:!0}).order("name",{ascending:!0});return(console.log("[getMenus] store_id:",e.store_id),console.log("[getMenus] menus count:",f?.length),console.log("[getMenus] menus data:",f),console.log("[getMenus] error:",g),g)?(console.error("Error fetching menus:",g),[]):f}async function f(){return Array.from(new Set((await e()).map(a=>a.category))).sort()}async function g(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)throw Error("No profile found");let{data:e}=await a.from("profiles").select("store_id, role_id, role").eq("id",d.current_profile_id).maybeSingle();if(!e?.store_id)throw Error("No store found");if(console.log("[checkMenuPermission] profile:",{role:e.role,role_id:e.role_id,store_id:e.store_id}),e.role_id){let{data:b}=await a.from("store_roles").select("permissions").eq("id",e.role_id).single();if(console.log("[checkMenuPermission] store_role permissions:",b?.permissions),!b?.permissions?.can_manage_menus){if(console.log("[checkMenuPermission] Missing can_manage_menus permission, checking role fallback"),"staff"!==e.role)throw Error("Insufficient permissions");console.log("[checkMenuPermission] Allowed via staff role fallback")}}else if(console.log("[checkMenuPermission] No role_id, using legacy role check"),"staff"!==e.role)throw Error("Insufficient permissions");return e}async function h(a){let b=await (0,c.createServerClient)(),e=await g(),f=a.get("name"),h=a.get("category"),i=parseInt(a.get("price"));if(!f||!h||isNaN(i))throw Error("Invalid input");let{error:j}=await b.from("menus").insert({store_id:e.store_id,name:f,category:h,price:i});if(j)throw console.error("Error creating menu:",j),Error("Failed to create menu");return(0,d.revalidatePath)("/app/menus"),{success:!0}}async function i(a){let b=await (0,c.createServerClient)();await g();let e=a.get("id"),f=a.get("name"),h=a.get("category"),i=parseInt(a.get("price"));if(!e||!f||!h||isNaN(i))throw Error("Invalid input");let{error:j}=await b.from("menus").update({name:f,category:h,price:i,updated_at:new Date().toISOString()}).eq("id",e);if(j)throw console.error("Error updating menu:",j),Error("Failed to update menu");return(0,d.revalidatePath)("/app/menus"),{success:!0}}async function j(a){let b=await (0,c.createServerClient)();await g();let{error:e}=await b.from("menus").delete().eq("id",a);if(e)throw console.error("Error deleting menu:",e),Error("Failed to delete menu");return(0,d.revalidatePath)("/app/menus"),{success:!0}}async function k(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:g}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();return g&&g.store_id?"staff"!==g.role?{redirect:"/app/timecard"}:{data:{menus:await e(),categories:await f()}}:{redirect:"/app/me"}}(0,a.i(13095).ensureServerEntryExports)([e,f,h,i,j,k]),(0,b.registerServerReference)(e,"00e241e9b8fcf03b19909349ec766f9fc7fbab803a",null),(0,b.registerServerReference)(f,"00853454e5775705cc1b195a9c86483bc7f02c438c",null),(0,b.registerServerReference)(h,"4053f19b6ba98e578a5988f028429cf9430ddcb1bf",null),(0,b.registerServerReference)(i,"4070165c305bd13da630c1b8b8cc0969aae9be5211",null),(0,b.registerServerReference)(j,"40691d237e8932b9146ced4ea863c081d5f59d1a9d",null),(0,b.registerServerReference)(k,"007a7840f828b7a7a53137cf7b43b806ece13a0e72",null),a.s(["createMenu",()=>h,"deleteMenu",()=>j,"getMenuCategories",()=>f,"getMenus",()=>e,"getMenusData",()=>k,"updateMenu",()=>i])},83944,a=>{"use strict";var b=a.i(37936),c=a.i(18558),d=a.i(9480);async function e(a){let b=await (0,d.createServerClient)(),{data:{user:c}}=await b.auth.getUser();if(!c)throw Error("Unauthorized");let{data:e}=await b.from("users").select("current_profile_id").eq("id",c.id).maybeSingle();if(!e?.current_profile_id)throw Error("No profile found");let{data:f}=await b.from("profiles").select("store_id").eq("id",e.current_profile_id).maybeSingle();if(!f?.store_id)throw Error("No store found");let g=b.from("bottle_keeps").select(`
      *,
      menus (
        id,
        name,
        category,
        price
      ),
      bottle_keep_holders (
        profile_id,
        profiles (
          id,
          display_name
        )
      )
    `).eq("store_id",f.store_id).order("created_at",{ascending:!1});a?.status&&"all"!==a.status&&(g=g.eq("status",a.status));let{data:h,error:i}=await g;if(i)throw console.error("Error fetching bottle keeps:",i),i;if(a?.search){let b=a.search.toLowerCase();return h?.filter(a=>{let c=a.menus?.name?.toLowerCase()||"",d=a.bottle_keep_holders?.map(a=>a.profiles?.display_name?.toLowerCase()||"").join(" ");return c.includes(b)||d.includes(b)})}return h}async function f(a){let b=await (0,d.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile found");let{data:g}=await b.from("profiles").select("store_id").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("No store found");let h=a.get("menu_id"),i=parseInt(a.get("remaining_amount"))||100,j=a.get("opened_at"),k=a.get("expiration_date")||null,l=a.get("memo")||null,m=a.get("profile_ids"),n=m?JSON.parse(m):[],{data:o,error:p}=await b.from("bottle_keeps").insert({store_id:g.store_id,menu_id:h,remaining_amount:i,opened_at:j,expiration_date:k,memo:l}).select().single();if(p)throw console.error("Error creating bottle keep:",p),p;if(n.length>0){let a=n.map(a=>({bottle_keep_id:o.id,profile_id:a})),{error:c}=await b.from("bottle_keep_holders").insert(a);if(c)throw console.error("Error creating bottle keep holders:",c),c}return(0,c.revalidatePath)("/app/bottles"),{success:!0}}async function g(a,b){let e=await (0,d.createServerClient)(),{data:{user:f}}=await e.auth.getUser();if(!f)throw Error("Unauthorized");let g=parseInt(b.get("remaining_amount")),h=b.get("status"),i=b.get("expiration_date")||null,j=b.get("memo")||null,k=b.get("profile_ids"),l=k?JSON.parse(k):[],{error:m}=await e.from("bottle_keeps").update({remaining_amount:g,status:h,expiration_date:i,memo:j,updated_at:new Date().toISOString()}).eq("id",a);if(m)throw console.error("Error updating bottle keep:",m),m;if(await e.from("bottle_keep_holders").delete().eq("bottle_keep_id",a),l.length>0){let b=l.map(b=>({bottle_keep_id:a,profile_id:b})),{error:c}=await e.from("bottle_keep_holders").insert(b);if(c)throw console.error("Error updating bottle keep holders:",c),c}return(0,c.revalidatePath)("/app/bottles"),{success:!0}}async function h(a){let b=await (0,d.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("Unauthorized");let{error:f}=await b.from("bottle_keeps").delete().eq("id",a);if(f)throw console.error("Error deleting bottle keep:",f),f;return(0,c.revalidatePath)("/app/bottles"),{success:!0}}(0,a.i(13095).ensureServerEntryExports)([e,f,g,h]),(0,b.registerServerReference)(e,"40d4255bde3a40e06cbba9327018213fdd3715a285",null),(0,b.registerServerReference)(f,"406ac45c0783e1af90b5ef914f0a0a0f0dd0751f05",null),(0,b.registerServerReference)(g,"6041bdd2e4dae44a41afa21525389d91048eec82d8",null),(0,b.registerServerReference)(h,"4081bb467de1e95924eb9ad27672a73dcd31e8e747",null),a.s(["createBottleKeep",()=>f,"deleteBottleKeep",()=>h,"getBottleKeeps",()=>e,"updateBottleKeep",()=>g])},97699,a=>{"use strict";var b=a.i(12095),c=a.i(40041),d=a.i(94239),e=a.i(20412),f=a.i(83944),g=a.i(86519),h=a.i(45861);a.s([],53030),a.i(53030),a.s(["005003103cf9137765c8b83fa0bcc8d85ef626e4fa",()=>b.getSettingsData,"00642b6ba2fcfa7262834fb54abfd4a10b7fd12d56",()=>b.signOut,"00a232eb085a0951373733706b35c0c0ea07607aa5",()=>h.getRolesData,"00a3ece0f08af191db378518d182c60ae58e5644ab",()=>b.deleteStore,"00a5fe1c9ebf4b8eac0bfb2ac26badbfac17290c2b",()=>d.getCurrentUserProfileId,"00af8e2dc2f7222e26f0f54a39bfb791519379a9a2",()=>c.getJoinRequestsData,"00d692a8991a77d14a953f671fadf7ca43ce78a0e6",()=>b.deleteStoreIcon,"00d9e4a5cc4e76c5250a3795b040d5e078b703757f",()=>c.getInvitationsData,"00e241e9b8fcf03b19909349ec766f9fc7fbab803a",()=>e.getMenus,"00e8e4d5ad38b65a60a88324e02b1556aaf771095a",()=>d.getAllProfiles,"401480709320f02adfc2c53fe10d5e53c5f50c595f",()=>b.uploadStoreIcon,"401b9edc6a21bc5fed5e321d79818fa8a31ed39a51",()=>c.getUninvitedProfiles,"40341d408f028c7c9e09e5718db53f79f7665ac28c",()=>b.updateTimecardSettings,"403be324e96604b07e3d40e85ad9ed05510f775e95",()=>g.createAttendance,"4045f18647982ea20967cf125e0fa243b6327117e9",()=>g.getAttendanceRecords,"404e99b8a0847028f660fbc984b5dd6745e3b9c778",()=>h.deleteRole,"4051358d725b4044b4fdbd74318bae0cb8a8202223",()=>h.createRole,"4053f19b6ba98e578a5988f028429cf9430ddcb1bf",()=>e.createMenu,"405876b122190683f26917671ae7068209f3aa4158",()=>b.updateStore,"405a3002f6f21537774442b0b95e2dd58bbb99e2d9",()=>d.toggleCommentLike,"405bcd64a4bdfaf384e28eef70d6feb4dab0c1c2a1",()=>g.updateAttendance,"405c7cfb7acf03ff32fbbb80b7519d602d9c21f819",()=>b.createStore,"405d88bef58e495845168b770b6ef6545da02343bd",()=>d.getUserBottleKeeps,"406043f51f142c0dd818afbb66f0171427e7776683",()=>h.getRoles,"40627c04ddfab389b3c9a4913a69a6119f43db382a",()=>b.updateTheme,"40691d237e8932b9146ced4ea863c081d5f59d1a9d",()=>e.deleteMenu,"406ac45c0783e1af90b5ef914f0a0a0f0dd0751f05",()=>f.createBottleKeep,"4070165c305bd13da630c1b8b8cc0969aae9be5211",()=>e.updateMenu,"407f73d041bbeb8a449b1a11854978deb1f2bd26db",()=>c.createInvitation,"4084b6043912cd8a75569f2d971d9e162ea4de2c3f",()=>d.deleteProfileComment,"40a7d24dbb5a7d9dfb1a862bc601d5443013a95d2a",()=>d.deleteProfileAvatar,"40ac9d7a98c2a78cd988100eef4e5e7d91131859e8",()=>d.getProfileDetails,"40c628f1df5e654f322ec7aa92c201a2ef9b13090c",()=>c.getInvitationByToken,"40c6ac2758dfc3a203b0445eadd0044237a7643d08",()=>c.cancelInvitation,"40d281ed84b38ac668808ba72195ebb5e55f757c52",()=>c.acceptInvitation,"40d39c086fd86461c7bae6b63e57f6f4ac6ba7b97d",()=>g.deleteAttendance,"40d454b66dc7597bde21ab5ab88ac6c1291aba3456",()=>d.deleteUser,"40d54faf838f60a57d913423bb21d98cd0140e82a1",()=>d.updateUser,"40e631752d3f63866f4bfdcefb52b39b7a16b9beed",()=>d.createUser,"40fa5639615fcc2f608746959cf859a32c49629715",()=>b.updateFeatureSettings,"60098d0194cb419a6fd3cf8152bc46b394969a1e7d",()=>c.getInvitations,"60211aeb80c05ed8abf26656abe964d684267a3d74",()=>h.assignRole,"6032599c457d1d9c38a767c7a62a3e4304032c930b",()=>d.uploadProfileAvatar,"6037218bf15dafe2b6f4a84653a7896a5f707e4376",()=>d.addProfileComment,"6041bdd2e4dae44a41afa21525389d91048eec82d8",()=>f.updateBottleKeep,"6063814e7fe3c93c0a64c2da9f1839dde3930ad582",()=>h.updateRole,"60819da50ce93994448e38298ecedf8232cced91bd",()=>d.updateProfileComment,"7013ab3c5d7056545e992425288ac07f894e0f9321",()=>d.updateProfileRelationships],97699)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__bc22d7c6._.js.map