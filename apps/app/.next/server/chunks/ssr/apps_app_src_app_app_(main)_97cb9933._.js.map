{"version":3,"sources":["../../../../../../apps/app/src/app/app/%28main%29/attendance/actions.ts","../../../../../../apps/app/src/app/app/%28main%29/users/actions.ts"],"sourcesContent":["\"use server\";\n\nimport { createServerClient } from \"@/lib/supabaseServerClient\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\n\nimport { createServiceRoleClient } from \"@/lib/supabaseServiceClient\";\n\nexport async function createAttendance(formData: FormData) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    // Resolve current profile via users.current_profile_id\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"No active profile found for current user\");\n    }\n\n    const targetProfileId = (formData.get(\"profileId\") as string | null) ?? appUser.current_profile_id;\n\n    // Ensure target profile belongs to the same store as current profile\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile || !currentProfile.store_id) {\n        throw new Error(\"Current profile has no store\");\n    }\n\n    const { data: targetProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id\")\n        .eq(\"id\", targetProfileId)\n        .maybeSingle();\n\n    if (!targetProfile || targetProfile.store_id !== currentProfile.store_id) {\n        throw new Error(\"Selected profile does not belong to current store\");\n    }\n\n    const date = formData.get(\"date\") as string;\n    const status = formData.get(\"status\") as string;\n    const startTime = formData.get(\"startTime\") as string;\n    const endTime = formData.get(\"endTime\") as string;\n    const pickupDestination = formData.get(\"pickup_destination\") as string;\n\n    // Convert HH:MM or HH:MM:SS to ISO string for the given date, treating input as JST\n    const timeToISO = (timeStr: string | null, dateStr: string): string | null => {\n        if (!timeStr) return null;\n        const normalized = /^\\d{2}:\\d{2}$/.test(timeStr) ? `${timeStr}:00` : timeStr;\n        // Create date object treating the input as JST (+09:00)\n        // Format: YYYY-MM-DDTHH:mm:ss+09:00\n        return new Date(`${dateStr}T${normalized}+09:00`).toISOString();\n    };\n\n    // Prepare time_cards payload based on status\n    const payload: any = {\n        user_id: targetProfileId,\n        work_date: date,\n        pickup_destination: pickupDestination || null,\n    };\n\n    // Save start time if provided, or default based on status\n    if (startTime) {\n        const clockInTime = timeToISO(startTime, date);\n        payload.clock_in = clockInTime;\n        payload.scheduled_start_time = clockInTime;\n    } else if (status === \"working\" || status === \"finished\") {\n        // Default to 00:00 JST if status implies working but no time given\n        const clockInTime = new Date(`${date}T00:00:00+09:00`).toISOString();\n        payload.clock_in = clockInTime;\n        payload.scheduled_start_time = clockInTime;\n    } else {\n        payload.clock_in = null;\n        payload.scheduled_start_time = null;\n    }\n\n    // Save end time if provided, regardless of status\n    if (endTime) {\n        const clockOutTime = timeToISO(endTime, date);\n        payload.clock_out = clockOutTime;\n        payload.scheduled_end_time = clockOutTime;\n    } else if (status === \"finished\") {\n        // If no end time but status is finished, use end of day JST\n        const clockOutTime = new Date(`${date}T23:59:59+09:00`).toISOString();\n        payload.clock_out = clockOutTime;\n        payload.scheduled_end_time = clockOutTime;\n    } else {\n        // Clear end time for working/scheduled/absent statuses when no end time provided\n        payload.clock_out = null;\n        payload.scheduled_end_time = null;\n    }\n\n    const { error } = await supabase.from(\"time_cards\").insert(payload);\n\n    if (error) {\n        console.error(\"Error creating time card:\", error);\n        console.error(\"Error details:\", JSON.stringify(error, null, 2));\n        throw new Error(`Failed to create time card: ${error.message || JSON.stringify(error)}`);\n    }\n\n    console.log(\"Time card created successfully!\");\n\n    revalidatePath(\"/app/attendance\");\n    return { success: true };\n}\n\nexport async function updateAttendance(formData: FormData) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    const id = formData.get(\"id\") as string;\n    const profileId = formData.get(\"profileId\") as string;\n    const date = formData.get(\"date\") as string;\n    const status = formData.get(\"status\") as string;\n    const startTime = formData.get(\"startTime\") as string;\n    const endTime = formData.get(\"endTime\") as string;\n    const pickupDestination = formData.get(\"pickup_destination\") as string;\n\n    if (!id) {\n        throw new Error(\"Time card id is required\");\n    }\n\n    // Resolve current profile and store\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"No active profile found for current user\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile || !currentProfile.store_id) {\n        throw new Error(\"Current profile has no store\");\n    }\n\n    // Ensure selected profile belongs to the same store\n    if (profileId) {\n        const { data: targetProfile } = await supabase\n            .from(\"profiles\")\n            .select(\"id, store_id\")\n            .eq(\"id\", profileId)\n            .maybeSingle();\n\n        if (!targetProfile || targetProfile.store_id !== currentProfile.store_id) {\n            throw new Error(\"Selected profile does not belong to current store\");\n        }\n    }\n\n    // Convert HH:MM or HH:MM:SS to ISO string for the given date, treating input as JST\n    const timeToISO = (timeStr: string | null, dateStr: string): string | null => {\n        if (!timeStr) return null;\n        const normalized = /^\\d{2}:\\d{2}$/.test(timeStr) ? `${timeStr}:00` : timeStr;\n        // Create date object treating the input as JST (+09:00)\n        // Format: YYYY-MM-DDTHH:mm:ss+09:00\n        return new Date(`${dateStr}T${normalized}+09:00`).toISOString();\n    };\n\n    // Prepare update payload\n    const payload: any = {\n        user_id: profileId || appUser.current_profile_id,\n        work_date: date,\n        pickup_destination: pickupDestination || null,\n    };\n\n    // Save start time if provided, or default based on status\n    if (startTime) {\n        const clockInTime = timeToISO(startTime, date);\n        payload.clock_in = clockInTime;\n        payload.scheduled_start_time = clockInTime;\n    } else if (status === \"working\" || status === \"finished\") {\n        // Default to 00:00 JST if status implies working but no time given\n        const clockInTime = new Date(`${date}T00:00:00+09:00`).toISOString();\n        payload.clock_in = clockInTime;\n        payload.scheduled_start_time = clockInTime;\n    } else {\n        payload.clock_in = null;\n        payload.scheduled_start_time = null;\n    }\n\n    // Save end time if provided, regardless of status\n    if (endTime) {\n        const clockOutTime = timeToISO(endTime, date);\n        payload.clock_out = clockOutTime;\n        payload.scheduled_end_time = clockOutTime;\n    } else if (status === \"finished\") {\n        // If no end time but status is finished, use end of day JST\n        const clockOutTime = new Date(`${date}T23:59:59+09:00`).toISOString();\n        payload.clock_out = clockOutTime;\n        payload.scheduled_end_time = clockOutTime;\n    } else {\n        // Clear end time for working/scheduled/absent statuses when no end time provided\n        payload.clock_out = null;\n        payload.scheduled_end_time = null;\n    }\n\n    const { error } = await supabase\n        .from(\"time_cards\")\n        .update(payload)\n        .eq(\"id\", id);\n\n    if (error) {\n        console.error(\"Error updating time card:\", error);\n        console.error(\"Error details:\", JSON.stringify(error, null, 2));\n        throw new Error(`Failed to update time card: ${error.message || JSON.stringify(error)}`);\n    }\n\n    revalidatePath(\"/app/attendance\");\n    return { success: true };\n}\n\nexport async function importAttendanceFromCsv(formData: FormData) {\n    const file = formData.get(\"file\") as File | null;\n    if (!file) {\n        throw new Error(\"CSVファイルが指定されていません\");\n    }\n\n    const roleFilter = (formData.get(\"attendanceRole\") as string | null) ?? null; // \"cast\" | \"staff\"\n\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    // Resolve current profile via users.current_profile_id\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"No active profile found for current user\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) {\n        throw new Error(\"Current profile has no store\");\n    }\n\n    // Build name -> profile map for the selected role in this store\n    const { data: storeProfiles } = await supabase\n        .from(\"profiles\")\n        .select(\"id, display_name, role\")\n        .eq(\"store_id\", currentProfile.store_id);\n\n    const nameToProfileId = new Map<string, string | null>();\n    for (const p of storeProfiles || []) {\n        const displayName = (p.display_name as string | null)?.trim().toLowerCase();\n        if (!displayName) continue;\n\n        const role = p.role as string | null;\n        if (roleFilter === \"cast\" && role !== \"cast\") continue;\n        if (roleFilter === \"staff\" && role !== \"staff\") continue;\n\n        if (!nameToProfileId.has(displayName)) {\n            nameToProfileId.set(displayName, p.id as string);\n        } else {\n            // ambiguous\n            nameToProfileId.set(displayName, null);\n        }\n    }\n\n    const text = await file.text();\n    const lines = text.split(/\\r?\\n/).map((line) => line.trim()).filter((line) => line.length > 0);\n    if (lines.length < 2) {\n        throw new Error(\"CSVに有効なデータ行がありません\");\n    }\n\n    const header = lines[0].split(\",\").map((h) => h.trim());\n    const colIndex = {\n        display_name: header.indexOf(\"display_name\"),\n        date: header.indexOf(\"date\"),\n        status: header.indexOf(\"status\"),\n        start_time: header.indexOf(\"start_time\"),\n        end_time: header.indexOf(\"end_time\"),\n    };\n\n    if (colIndex.display_name === -1 || colIndex.date === -1 || colIndex.status === -1) {\n        throw new Error(\"CSVヘッダーに display_name, date, status カラムが必要です\");\n    }\n\n    const normalizeTime = (value: string | undefined): string | null => {\n        const v = (value || \"\").trim();\n        if (!v) return null;\n        if (/^\\d{2}:\\d{2}$/.test(v)) return `${v}:00`;\n        if (/^\\d{2}:\\d{2}:\\d{2}$/.test(v)) return v;\n        return null;\n    };\n\n    const toInsert: any[] = [];\n\n    for (let i = 1; i < lines.length; i++) {\n        const columns = lines[i].split(\",\");\n        const nameRaw = (columns[colIndex.display_name] || \"\").trim();\n        const date = (columns[colIndex.date] || \"\").trim();\n        const status = (columns[colIndex.status] || \"\").trim();\n\n        if (!nameRaw || !date || !status) continue;\n\n        const key = nameRaw.toLowerCase();\n        const profileId = nameToProfileId.get(key);\n        if (!profileId) continue; // 不明・曖昧ならスキップ\n\n        const startTime = colIndex.start_time !== -1 ? columns[colIndex.start_time] : undefined;\n        const endTime = colIndex.end_time !== -1 ? columns[colIndex.end_time] : undefined;\n\n        // Convert to time_cards format\n        const payload: any = {\n            user_id: profileId,\n            work_date: date,\n        };\n\n        // Map status to clock_in/clock_out\n        if (status === \"working\" || status === \"finished\") {\n            const normalizedStart = normalizeTime(startTime);\n            payload.clock_in = normalizedStart\n                ? new Date(`${date}T${normalizedStart}`).toISOString()\n                : new Date(`${date}T00:00:00`).toISOString();\n        } else {\n            payload.clock_in = null;\n        }\n\n        if (status === \"finished\") {\n            const normalizedEnd = normalizeTime(endTime);\n            payload.clock_out = normalizedEnd\n                ? new Date(`${date}T${normalizedEnd}`).toISOString()\n                : new Date(`${date}T23:59:59`).toISOString();\n        } else {\n            payload.clock_out = null;\n        }\n\n        toInsert.push(payload);\n    }\n\n    if (toInsert.length === 0) {\n        revalidatePath(\"/app/attendance\");\n        return;\n    }\n\n    const { error } = await supabase.from(\"time_cards\").insert(toInsert);\n\n    if (error) {\n        console.error(\"Error importing time cards from CSV:\", error);\n        console.error(\"Error details:\", JSON.stringify(error, null, 2));\n        throw new Error(\"CSVのインポート中にエラーが発生しました\");\n    }\n\n    revalidatePath(\"/app/attendance\");\n}\n\nexport async function getAttendanceRecords(profileId: string) {\n    const supabase = await createServerClient();\n\n    // Basic auth check\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    // Fetch time cards for the profile\n    // Order by work_date desc\n    const { data: records, error } = await supabase\n        .from(\"time_cards\")\n        .select(\"*\")\n        .eq(\"user_id\", profileId)\n        .order(\"work_date\", { ascending: false });\n\n    if (error) {\n        console.error(\"Error fetching attendance records:\", error);\n        throw new Error(\"勤怠履歴の取得に失敗しました\");\n    }\n\n    return records;\n}\n\nexport async function getAttendanceData(roleParam?: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        return { redirect: \"/login\" };\n    }\n\n    // Resolve current profile via users.current_profile_id\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        return { redirect: \"/app/me\" };\n    }\n\n    // Fetch current profile to get store and role\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id, role, stores(*)\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile || !currentProfile.store_id) {\n        return { redirect: \"/app/me\" };\n    }\n\n    const store = currentProfile.stores as any;\n    if (store && store.show_attendance === false) {\n        return { redirect: \"/app/timecard\" };\n    }\n\n    // Role check\n    if (currentProfile.role !== \"staff\") {\n        return { redirect: \"/app/timecard\" };\n    }\n\n    const roleFilter: \"staff\" | \"cast\" = roleParam === \"staff\" ? \"staff\" : \"cast\";\n\n    // Fetch all profiles for the current store\n    const { data: storeProfiles, error: profilesError } = await supabase\n        .from(\"profiles\")\n        .select(\"id, display_name, real_name, role, store_id\")\n        .eq(\"store_id\", currentProfile.store_id);\n\n    if (profilesError) {\n        console.error(\"Error fetching store profiles:\", profilesError);\n    }\n\n    const allProfiles = storeProfiles || [];\n\n    const profileMap: Record<string, any> = {};\n    const profileIds: string[] = [];\n\n    for (const p of allProfiles) {\n        profileMap[p.id] = p;\n        profileIds.push(p.id);\n    }\n\n    // Fetch time_cards for the last 30 days\n    const serviceSupabase = createServiceRoleClient();\n    const today = new Date();\n    const from = new Date();\n    from.setDate(today.getDate() - 30);\n    const fromStr = from.toISOString().split(\"T\")[0];\n\n    let allRecords: any[] = [];\n\n    if (profileIds.length > 0) {\n        const { data: timeCardRows, error: timeCardsError } = await serviceSupabase\n            .from(\"time_cards\")\n            .select(\"id, user_id, work_date, clock_in, clock_out, scheduled_start_time, scheduled_end_time, forgot_clockout, pickup_destination\")\n            .in(\"user_id\", profileIds)\n            .gte(\"work_date\", fromStr)\n            .order(\"work_date\", { ascending: false });\n\n        if (timeCardsError) {\n            console.error(\"Error fetching time cards for attendance:\", timeCardsError);\n        } else {\n            const timeCards = (timeCardRows || []) as any[];\n\n            allRecords = timeCards.map((tc) => {\n                let status = \"scheduled\";\n                if (tc.forgot_clockout) {\n                    status = \"forgot_clockout\";\n                } else if (tc.clock_out) {\n                    status = \"finished\";\n                } else if (tc.clock_in) {\n                    status = \"working\";\n                }\n\n                // Format times for display (HH:MM)\n                const formatTimeStr = (isoStr: string | null) => {\n                    if (!isoStr) return null;\n                    const date = new Date(isoStr);\n                    const hours = String(date.getHours()).padStart(2, \"0\");\n                    const minutes = String(date.getMinutes()).padStart(2, \"0\");\n                    return `${hours}:${minutes}`;\n                };\n\n                const prof = profileMap[tc.user_id];\n\n                return {\n                    id: tc.id,\n                    user_id: tc.user_id,\n                    date: tc.work_date,\n                    name: prof ? prof.display_name : \"不明\",\n                    status,\n                    // Use scheduled times if available, otherwise fall back to actual clock times\n                    start_time: formatTimeStr(tc.scheduled_start_time || tc.clock_in),\n                    end_time: formatTimeStr(tc.scheduled_end_time || tc.clock_out),\n                    clock_in: formatTimeStr(tc.clock_in),\n                    clock_out: formatTimeStr(tc.clock_out),\n                    pickup_destination: tc.pickup_destination,\n                };\n            });\n\n            // Sort by date desc, then time desc\n            allRecords.sort((a, b) => {\n                if (a.date !== b.date) return b.date.localeCompare(a.date);\n                const aTime = a.clock_in || \"\";\n                const bTime = b.clock_in || \"\";\n                return bTime.localeCompare(aTime);\n            });\n        }\n    }\n\n    return {\n        data: {\n            allRecords,\n            allProfiles,\n            roleFilter,\n        }\n    };\n}\n\nexport async function deleteAttendance(id: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    if (!id) {\n        throw new Error(\"Time card id is required\");\n    }\n\n    // Resolve current profile and store\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"No active profile found for current user\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile || !currentProfile.store_id) {\n        throw new Error(\"Current profile has no store\");\n    }\n\n    // Verify the time card belongs to a user in the same store\n    // Fetch the time card first\n    const { data: timeCard } = await supabase\n        .from(\"time_cards\")\n        .select(\"user_id\")\n        .eq(\"id\", id)\n        .maybeSingle();\n\n    if (!timeCard) {\n        throw new Error(\"Time card not found\");\n    }\n\n    const { data: targetProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", timeCard.user_id)\n        .maybeSingle();\n\n    if (!targetProfile || targetProfile.store_id !== currentProfile.store_id) {\n        throw new Error(\"Cannot delete time card from another store\");\n    }\n\n    const { error } = await supabase\n        .from(\"time_cards\")\n        .delete()\n        .eq(\"id\", id);\n\n    if (error) {\n        console.error(\"Error deleting time card:\", error);\n        throw new Error(\"Failed to delete time card\");\n    }\n\n    revalidatePath(\"/app/attendance\");\n    return { success: true };\n}\n","\"use server\";\n\nimport { createServerClient } from \"@/lib/supabaseServerClient\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function createUser(formData: FormData) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect(\"/login\");\n    }\n\n    const displayName = formData.get(\"displayName\") as string;\n    const displayNameKana = (formData.get(\"displayNameKana\") as string | null)?.trim() || null;\n    const realName = formData.get(\"realName\") as string;\n    const realNameKana = formData.get(\"realNameKana\") as string;\n    const role = formData.get(\"role\") as string;\n    const guestAddressee = (formData.get(\"guestAddressee\") as string | null)?.trim() || null;\n    const guestReceiptTypeRaw = (formData.get(\"guestReceiptType\") as string | null) ?? \"none\";\n    const guestReceiptType = [\"none\", \"amount_only\", \"with_date\"].includes(guestReceiptTypeRaw)\n        ? guestReceiptTypeRaw\n        : \"none\";\n\n    if (!displayName || !role) {\n        throw new Error(\"必須項目が入力されていません\");\n    }\n\n    // Get current user's store\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    // Create new profile\n    // Note: user_id is omitted (null) for guests/staff created this way\n    const { error } = await supabase.from(\"profiles\").insert({\n        display_name: displayName,\n        display_name_kana: displayNameKana,\n        real_name: realName,\n        real_name_kana: realNameKana,\n        role: role,\n        store_id: currentProfile.store_id,\n        user_id: null, // Explicitly set to null to avoid default value issues\n        guest_addressee: role === \"guest\" ? guestAddressee : null,\n        guest_receipt_type: role === \"guest\" ? guestReceiptType : \"none\",\n    });\n\n    if (error) {\n        console.error(\"Error creating user:\", error);\n        throw new Error(`ユーザーの作成に失敗しました: ${error.message}`);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function importUsersFromCsv(formData: FormData) {\n    const file = formData.get(\"file\") as File | null;\n    if (!file) {\n        throw new Error(\"CSVファイルが指定されていません\");\n    }\n\n    const roleOverride = (formData.get(\"userRole\") as string | null) ?? null;\n\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect(\"/login\");\n    }\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    const text = await file.text();\n    const lines = text.split(/\\r?\\n/).map((line) => line.trim()).filter((line) => line.length > 0);\n\n    if (lines.length < 2) {\n        throw new Error(\"CSVに有効なデータ行がありません\");\n    }\n\n    const header = lines[0].split(\",\").map((h) => h.trim());\n    const colIndex = {\n        display_name: header.indexOf(\"display_name\"),\n        display_name_kana: header.indexOf(\"display_name_kana\"),\n        real_name: header.indexOf(\"real_name\"),\n        real_name_kana: header.indexOf(\"real_name_kana\"),\n        role: header.indexOf(\"role\"),\n    };\n\n    if (colIndex.display_name === -1) {\n        throw new Error(\"CSVヘッダーに display_name カラムが必要です\");\n    }\n    if (colIndex.role === -1 && !roleOverride) {\n        throw new Error(\"role カラムが存在しない場合は、インポートするロールを画面で選択してください\");\n    }\n\n    const { data: existingProfiles } = await supabase\n        .from(\"profiles\")\n        .select(\"display_name, display_name_kana\")\n        .eq(\"store_id\", currentProfile.store_id);\n\n    const existingNames = new Set(\n        (existingProfiles || [])\n            .map((p: any) => (p.display_name as string | null)?.trim().toLowerCase())\n            .filter((name): name is string => !!name)\n    );\n\n    const toInsert: any[] = [];\n\n    for (let i = 1; i < lines.length; i++) {\n        const columns = lines[i].split(\",\");\n        const displayName = (columns[colIndex.display_name] || \"\").trim();\n        const csvRole = colIndex.role !== -1 ? (columns[colIndex.role] || \"\").trim() : \"\";\n        const role = roleOverride || csvRole;\n\n        if (!displayName || !role) {\n            continue;\n        }\n\n        const key = displayName.toLowerCase();\n        if (existingNames.has(key)) {\n            // 同じ display_name が既に存在する場合はスキップ\n            continue;\n        }\n\n        const displayNameKana =\n            colIndex.display_name_kana !== -1 ? (columns[colIndex.display_name_kana] || \"\").trim() : \"\";\n        const realName = colIndex.real_name !== -1 ? (columns[colIndex.real_name] || \"\").trim() : \"\";\n        const realNameKana = colIndex.real_name_kana !== -1 ? (columns[colIndex.real_name_kana] || \"\").trim() : \"\";\n\n        toInsert.push({\n            display_name: displayName,\n            display_name_kana: displayNameKana || null,\n            real_name: realName,\n            real_name_kana: realNameKana,\n            role,\n            store_id: currentProfile.store_id,\n            user_id: null,\n        });\n\n        existingNames.add(key);\n    }\n\n    if (toInsert.length === 0) {\n        revalidatePath(\"/app/users\");\n        return;\n    }\n\n    const { error } = await supabase.from(\"profiles\").insert(toInsert);\n\n    if (error) {\n        console.error(\"Error importing users from CSV:\", error);\n        throw new Error(\"CSVのインポート中にエラーが発生しました\");\n    }\n\n    revalidatePath(\"/app/users\");\n}\n\nexport async function updateUser(formData: FormData) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        redirect(\"/login\");\n    }\n\n    const profileId = formData.get(\"profileId\") as string;\n    const displayName = formData.get(\"displayName\") as string;\n    const displayNameKana = (formData.get(\"displayNameKana\") as string | null)?.trim() || null;\n    const realName = (formData.get(\"realName\") as string | null) ?? \"\";\n    const realNameKana = (formData.get(\"realNameKana\") as string | null) ?? \"\";\n    const role = formData.get(\"role\") as string;\n    const guestAddressee = (formData.get(\"guestAddressee\") as string | null)?.trim() || null;\n    const guestReceiptTypeRaw = (formData.get(\"guestReceiptType\") as string | null) ?? \"none\";\n    const guestReceiptType = [\"none\", \"amount_only\", \"with_date\"].includes(guestReceiptTypeRaw)\n        ? guestReceiptTypeRaw\n        : \"none\";\n\n    if (!profileId || !displayName || !role) {\n        throw new Error(\"必須項目が入力されていません\");\n    }\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id, role, role_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    // Check if we are changing the role from Admin to something else\n    if (currentProfile.role === \"staff\" && role !== \"staff\") {\n        // Check if this is the last admin\n        const { count, error: countError } = await supabase\n            .from(\"profiles\")\n            .select(\"*\", { count: \"exact\", head: true })\n            .eq(\"store_id\", currentProfile.store_id)\n            .eq(\"role\", \"staff\");\n\n        if (countError) {\n            console.error(\"Error checking admin count:\", countError);\n            throw new Error(\"管理者数の確認に失敗しました\");\n        }\n\n        if (count !== null && count <= 1) {\n            throw new Error(\"店舗には少なくとも1人のスタッフが必要です\");\n        }\n    }\n\n    // Also check for new role system (role_id)\n    // If currentProfile has a role_id that corresponds to a system admin role\n    if (currentProfile.role_id) {\n        const { data: currentRole } = await supabase\n            .from(\"store_roles\")\n            .select(\"name, is_system_role\")\n            .eq(\"id\", currentProfile.role_id)\n            .single();\n\n        if (currentRole?.name === \"スタッフ\" && currentRole?.is_system_role) {\n            // If we are changing the role (assuming role passed here is the string role, but we might need to handle role_id change too if UI supports it)\n            // The current UI seems to pass 'role' string (admin/staff/cast/guest).\n            // If the intention is to change the role, we need to be careful.\n            // However, the current `updateUser` function updates the `role` column, not `role_id`.\n            // We should probably update `role_id` as well based on the selected `role` string if we want to keep them in sync,\n            // OR we need to update the UI to send `roleId`.\n            // Given the current transition state, let's stick to the `role` column check for now as that's what the UI sends.\n            // But wait, if I created a default Admin role, I should probably check that too.\n\n            // Let's check if there are other users with the \"管理者\" role_id\n            const { count: roleCount } = await supabase\n                .from(\"profiles\")\n                .select(\"*\", { count: \"exact\", head: true })\n                .eq(\"store_id\", currentProfile.store_id)\n                .eq(\"role_id\", currentProfile.role_id);\n\n            if (roleCount !== null && roleCount <= 1 && role !== \"staff\") {\n                throw new Error(\"店舗には少なくとも1人のスタッフが必要です\");\n            }\n        }\n    }\n\n    const { error } = await supabase\n        .from(\"profiles\")\n        .update({\n            display_name: displayName,\n            display_name_kana: displayNameKana,\n            real_name: realName,\n            real_name_kana: realNameKana,\n            role,\n            guest_addressee: role === \"guest\" ? guestAddressee : null,\n            guest_receipt_type: role === \"guest\" ? guestReceiptType : \"none\",\n        })\n        .eq(\"id\", profileId)\n        .eq(\"store_id\", currentProfile.store_id);\n\n    if (error) {\n        console.error(\"Error updating user:\", error);\n        throw new Error(`ユーザーの更新に失敗しました: ${error.message}`);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function deleteUser(profileId: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        throw new Error(\"User not authenticated\");\n    }\n\n    // Resolve current profile and store to ensure permission\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        throw new Error(\"No active profile found for current user\");\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id, role\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) {\n        throw new Error(\"店舗情報が見つかりません\");\n    }\n\n    // Only admin or staff can delete users (adjust based on requirements, assuming staff/admin for now)\n    // Ideally check if currentProfile.role is 'admin' or 'staff'\n\n    // Verify the target profile belongs to the same store\n    const { data: targetProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", profileId)\n        .maybeSingle();\n\n    if (!targetProfile) {\n        throw new Error(\"ユーザーが見つかりません\");\n    }\n\n    if (targetProfile.store_id !== currentProfile.store_id) {\n        throw new Error(\"権限がありません\");\n    }\n\n    // Delete the profile\n    const { error } = await supabase.from(\"profiles\").delete().eq(\"id\", profileId);\n\n    if (error) {\n        console.error(\"Error deleting user:\", error);\n        throw new Error(`ユーザーの削除に失敗しました: ${error.message}`);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function getProfileDetails(profileId: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return null;\n\n    // Get current user's profile ID\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    const currentProfileId = appUser?.current_profile_id;\n\n    // Get relationships where profileId is source OR target\n    const { data: relationships, error: relError } = await supabase\n        .from(\"profile_relationships\")\n        .select(\"*\")\n        .or(`source_profile_id.eq.${profileId},target_profile_id.eq.${profileId}`);\n\n    if (relError) {\n        console.error(\"Error fetching relationships:\", relError);\n        return null;\n    }\n\n    // Get comments\n    const { data: comments, error: comError } = await supabase\n        .from(\"profile_comments\")\n        .select(`\n            *,\n            author:profiles!author_profile_id (\n                id,\n                display_name,\n                avatar_url\n            )\n        `)\n        .eq(\"target_profile_id\", profileId)\n        .order(\"updated_at\", { ascending: false });\n\n    if (comError) {\n        console.error(\"Error fetching comments:\", comError);\n        return null;\n    }\n\n    if (!comments || comments.length === 0) {\n        return {\n            relationships: relationships || [],\n            comments: [],\n        };\n    }\n\n    // Get all comment IDs\n    const commentIds = comments.map((c) => c.id);\n\n    // Fetch all likes for these comments in one query\n    const { data: allLikes } = await supabase\n        .from(\"profile_comment_likes\")\n        .select(\"comment_id, profile_id\")\n        .in(\"comment_id\", commentIds);\n\n    // Create a map of comment_id -> like count and user's like status\n    const likesMap = new Map<string, { count: number; userHasLiked: boolean }>();\n\n    commentIds.forEach((id) => {\n        const commentLikes = allLikes?.filter((like) => like.comment_id === id) || [];\n        likesMap.set(id, {\n            count: commentLikes.length,\n            userHasLiked: commentLikes.some((like) => like.profile_id === currentProfileId),\n        });\n    });\n\n    // Add like data to comments\n    const commentsWithLikes = comments.map((comment) => {\n        const likeData = likesMap.get(comment.id) || { count: 0, userHasLiked: false };\n        return {\n            ...comment,\n            like_count: likeData.count,\n            user_has_liked: likeData.userHasLiked,\n        };\n    });\n\n    return {\n        relationships: relationships || [],\n        comments: commentsWithLikes,\n    };\n}\n\nexport async function updateProfileRelationships(\n    profileId: string,\n    type: string,\n    targetProfileIds: string[]\n) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) throw new Error(\"Unauthorized\");\n\n    // Get current user's store\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) throw new Error(\"No profile\");\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) throw new Error(\"No store\");\n\n    // 1. Fetch existing relationships of this type for this profile\n    const { data: existing, error: fetchError } = await supabase\n        .from(\"profile_relationships\")\n        .select(\"*\")\n        .eq(\"relationship_type\", type)\n        .or(`source_profile_id.eq.${profileId},target_profile_id.eq.${profileId}`);\n\n    if (fetchError) throw new Error(fetchError.message);\n\n    const existingIds = new Set(\n        existing?.map((r) =>\n            r.source_profile_id === profileId ? r.target_profile_id : r.source_profile_id\n        )\n    );\n\n    const newIds = new Set(targetProfileIds);\n\n    // 2. Determine additions and removals\n    const toAdd = targetProfileIds.filter((id) => !existingIds.has(id));\n    const toRemove = Array.from(existingIds).filter((id) => !newIds.has(id));\n\n    // 3. Remove\n    if (toRemove.length > 0) {\n        // We need to delete where (source=profileId AND target IN toRemove) OR (target=profileId AND source IN toRemove)\n        // AND type = type\n        // Since we can't do complex ORs in delete easily with array, we iterate or do two queries.\n        // Simpler: Delete by ID if we had them, but we fetched them.\n        const idsToDelete = existing\n            ?.filter(\n                (r) =>\n                    toRemove.includes(r.source_profile_id === profileId ? r.target_profile_id : r.source_profile_id)\n            )\n            .map((r) => r.id);\n\n        if (idsToDelete && idsToDelete.length > 0) {\n            const { error: delError } = await supabase\n                .from(\"profile_relationships\")\n                .delete()\n                .in(\"id\", idsToDelete);\n            if (delError) throw new Error(delError.message);\n        }\n    }\n\n    // 4. Add\n    if (toAdd.length > 0) {\n        const toInsert = toAdd.map((targetId) => {\n            // Ensure source < target\n            const [source, target] = [profileId, targetId].sort();\n            return {\n                store_id: currentProfile.store_id,\n                source_profile_id: source,\n                target_profile_id: target,\n                relationship_type: type,\n            };\n        });\n\n        const { error: insError } = await supabase.from(\"profile_relationships\").insert(toInsert);\n        if (insError) throw new Error(insError.message);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function addProfileComment(targetProfileId: string, content: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) throw new Error(\"Unauthorized\");\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) throw new Error(\"No profile\");\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) throw new Error(\"No store\");\n\n    const { error } = await supabase.from(\"profile_comments\").insert({\n        store_id: currentProfile.store_id,\n        target_profile_id: targetProfileId,\n        author_profile_id: appUser.current_profile_id,\n        content: content,\n    });\n\n    if (error) throw new Error(error.message);\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function getAllProfiles() {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return [];\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) return [];\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) return [];\n\n    const { data: profiles } = await supabase\n        .from(\"profiles\")\n        .select(\"id, display_name, real_name, role, avatar_url\")\n        .eq(\"store_id\", currentProfile.store_id)\n        .order(\"display_name\");\n\n    return profiles || [];\n}\n\nexport async function getCurrentUserProfileId() {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return null;\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    return appUser?.current_profile_id || null;\n}\n\nexport async function updateProfileComment(commentId: string, content: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) throw new Error(\"Unauthorized\");\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) throw new Error(\"No profile\");\n\n    // Verify user is the author\n    const { data: comment } = await supabase\n        .from(\"profile_comments\")\n        .select(\"author_profile_id\")\n        .eq(\"id\", commentId)\n        .maybeSingle();\n\n    if (!comment || comment.author_profile_id !== appUser.current_profile_id) {\n        throw new Error(\"Unauthorized\");\n    }\n\n    const { error } = await supabase\n        .from(\"profile_comments\")\n        .update({ content, updated_at: new Date().toISOString() })\n        .eq(\"id\", commentId);\n\n    if (error) throw new Error(error.message);\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function deleteProfileComment(commentId: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) throw new Error(\"Unauthorized\");\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) throw new Error(\"No profile\");\n\n    // Verify user is the author\n    const { data: comment } = await supabase\n        .from(\"profile_comments\")\n        .select(\"author_profile_id\")\n        .eq(\"id\", commentId)\n        .maybeSingle();\n\n    if (!comment || comment.author_profile_id !== appUser.current_profile_id) {\n        throw new Error(\"Unauthorized\");\n    }\n\n    const { error } = await supabase\n        .from(\"profile_comments\")\n        .delete()\n        .eq(\"id\", commentId);\n\n    if (error) throw new Error(error.message);\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function toggleCommentLike(commentId: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) throw new Error(\"Unauthorized\");\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) throw new Error(\"No profile\");\n\n    // Check if already liked\n    const { data: existingLike } = await supabase\n        .from(\"profile_comment_likes\")\n        .select(\"id\")\n        .eq(\"comment_id\", commentId)\n        .eq(\"profile_id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (existingLike) {\n        // Unlike\n        const { error } = await supabase\n            .from(\"profile_comment_likes\")\n            .delete()\n            .eq(\"id\", existingLike.id);\n\n        if (error) throw new Error(error.message);\n    } else {\n        // Like\n        const { error } = await supabase\n            .from(\"profile_comment_likes\")\n            .insert({\n                comment_id: commentId,\n                profile_id: appUser.current_profile_id,\n            });\n\n        if (error) throw new Error(error.message);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\nexport async function getUsersData(roleParam?: string, query?: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n        return { redirect: \"/login\" };\n    }\n\n    const role = roleParam || \"cast\";\n\n    // Resolve current profile via users.current_profile_id\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) {\n        return { redirect: \"/app/me\" };\n    }\n\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"id, store_id, role, stores(*)\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile || !currentProfile.store_id) {\n        return { redirect: \"/app/me\" };\n    }\n\n    // Role check\n    if (currentProfile.role !== \"staff\") {\n        return { redirect: \"/app/timecard\" };\n    }\n\n    let queryBuilder = supabase\n        .from(\"profiles\")\n        .select(\"id, display_name, display_name_kana, real_name, real_name_kana, role, avatar_url, guest_addressee, guest_receipt_type\")\n        .eq(\"store_id\", currentProfile.store_id)\n        .eq(\"role\", role)\n        .order(\"display_name\");\n\n    if (query) {\n        queryBuilder = queryBuilder.or(`display_name.ilike.%${query}%,display_name_kana.ilike.%${query}%,real_name.ilike.%${query}%,real_name_kana.ilike.%${query}%`);\n    }\n\n    const { data: users, error } = await queryBuilder;\n\n    if (error) {\n        console.error(\"Error fetching users:\", error);\n        return { data: { users: [] } };\n    }\n\n    return {\n        data: {\n            users: users || [],\n        }\n    };\n}\n\nexport async function getUserBottleKeeps(profileId: string) {\n    const supabase = await createServerClient();\n    const {\n        data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) return [];\n\n    const { data: appUser } = await supabase\n        .from(\"users\")\n        .select(\"current_profile_id\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n\n    if (!appUser?.current_profile_id) return [];\n\n    // Check permission (same store)\n    const { data: currentProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", appUser.current_profile_id)\n        .maybeSingle();\n\n    if (!currentProfile?.store_id) return [];\n\n    const { data: targetProfile } = await supabase\n        .from(\"profiles\")\n        .select(\"store_id\")\n        .eq(\"id\", profileId)\n        .maybeSingle();\n\n    if (!targetProfile || targetProfile.store_id !== currentProfile.store_id) {\n        return [];\n    }\n\n    // Fetch bottle keeps via bottle_keep_holders\n    const { data: holders, error } = await supabase\n        .from(\"bottle_keep_holders\")\n        .select(`\n            bottle_keep_id,\n            bottle_keeps (\n                id,\n                menu_id,\n                opened_at,\n                expiration_date,\n                remaining_amount,\n                status,\n                memo,\n                menus (\n                    name,\n                    price\n                )\n            )\n        `)\n        .eq(\"profile_id\", profileId);\n\n    if (error) {\n        console.error(\"Error fetching user bottle keeps:\", error);\n        return [];\n    }\n\n    // Flatten the structure\n    const bottleKeeps = holders\n        ?.map((h: any) => h.bottle_keeps)\n        .filter((b: any) => b && b.status === \"active\") // Only active bottles\n        .map((b: any) => ({\n            ...b,\n            menu_name: b.menus?.name || \"不明なボトル\",\n            menu_price: b.menus?.price || 0,\n        }));\n\n    return bottleKeeps || [];\n}\n\nexport async function uploadProfileAvatar(profileId: string, formData: FormData) {\n    const supabase = await createServerClient();\n    const file = formData.get(\"file\") as File;\n\n    if (!file) {\n        throw new Error(\"ファイルが選択されていません\");\n    }\n\n    // Upload to Supabase Storage\n    const fileExt = file.name.split('.').pop();\n    const fileName = `${profileId}-${Date.now()}.${fileExt}`;\n    const filePath = `${fileName}`;\n\n    const { error: uploadError } = await supabase.storage\n        .from('avatars')\n        .upload(filePath, file);\n\n    if (uploadError) {\n        console.error(\"Upload error:\", uploadError);\n        throw new Error(`アップロードに失敗しました: ${uploadError.message}`);\n    }\n\n    // Get Public URL\n    const { data: { publicUrl } } = supabase.storage\n        .from('avatars')\n        .getPublicUrl(filePath);\n\n    // Update profile\n    const { error: updateError } = await supabase\n        .from(\"profiles\")\n        .update({ avatar_url: publicUrl })\n        .eq(\"id\", profileId);\n\n    if (updateError) {\n        console.error(\"Update error:\", updateError);\n        throw new Error(`プロフィールの更新に失敗しました: ${updateError.message}`);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true, publicUrl };\n}\n\nexport async function deleteProfileAvatar(profileId: string) {\n    const supabase = await createServerClient();\n\n    // Get current avatar url to delete file (optional, but good practice)\n    const { data: profile } = await supabase\n        .from(\"profiles\")\n        .select(\"avatar_url\")\n        .eq(\"id\", profileId)\n        .single();\n\n    if (profile?.avatar_url) {\n        const url = new URL(profile.avatar_url);\n        const path = url.pathname.split('/').pop(); // Simple extraction, might need adjustment based on URL structure\n        if (path) {\n            await supabase.storage.from('avatars').remove([path]);\n        }\n    }\n\n    // Update profile to remove avatar_url\n    const { error } = await supabase\n        .from(\"profiles\")\n        .update({ avatar_url: null })\n        .eq(\"id\", profileId);\n\n    if (error) {\n        throw new Error(`削除に失敗しました: ${error.message}`);\n    }\n\n    revalidatePath(\"/app/users\");\n    return { success: true };\n}\n\n"],"names":[],"mappings":"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"}