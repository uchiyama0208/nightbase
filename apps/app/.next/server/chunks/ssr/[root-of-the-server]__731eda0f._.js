module.exports=[54799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},45861,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);async function e(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).single();if(!d?.current_profile_id)throw Error("No profile found");let{data:e}=await a.from("profiles").select("store_id").eq("id",d.current_profile_id).single();if(!e?.store_id)throw Error("No store found");return e.store_id}async function f(a){let b=await (0,c.createServerClient)(),f=await e(),{error:g}=await b.from("store_roles").insert({store_id:f,name:a.name,permissions:a.permissions});if(g)throw Error(g.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function g(a,b){let f=await (0,c.createServerClient)(),g=await e(),{data:h,error:i}=await f.from("store_roles").select("is_system_role").eq("id",a).eq("store_id",g).single();if(i||!h)throw Error("Role not found");if(h.is_system_role)throw Error("システムロールは変更できません");let{error:j}=await f.from("store_roles").update({name:b.name,permissions:b.permissions}).eq("id",a).eq("store_id",g);if(j)throw Error(j.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function h(a){let b=await (0,c.createServerClient)(),f=await e(),{data:g,error:h}=await b.from("store_roles").select("is_system_role").eq("id",a).eq("store_id",f).single();if(h||!g)throw Error("Role not found");if(g.is_system_role)throw Error("システムロールは削除できません");let{error:i}=await b.from("store_roles").delete().eq("id",a).eq("store_id",f);if(i)throw Error(i.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function i(a,b){let f=await (0,c.createServerClient)(),g=await e(),{data:h}=await f.from("profiles").select("store_id").eq("id",a).single();if(!h||h.store_id!==g)throw Error("Invalid profile");let{error:i}=await f.from("profiles").update({role_id:b}).eq("id",a);if(i)throw Error(i.message);return(0,d.revalidatePath)("/app/roles"),{success:!0}}async function j(a){let b=await (0,c.createServerClient)();a||(a=await e());let{data:d,error:f}=await b.from("store_roles").select("*").eq("store_id",a).order("name");return f?(console.error("Error fetching roles:",f),[]):d}async function k(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};let f=e.stores;if(f&&!1===f.show_roles||"staff"!==e.role)return{redirect:"/app/timecard"};let[g,h]=await Promise.all([a.from("store_roles").select("*").eq("store_id",e.store_id).order("created_at",{ascending:!0}),a.from("profiles").select("id, display_name, real_name, role_id, role").eq("store_id",e.store_id)]),i=g.data,j=g.error,k=h.data,l=h.error;if(j)throw console.error("Error fetching roles:",j),Error(j.message);return l&&console.error("Error fetching profiles:",l),{data:{roles:i||[],profiles:k||[]}}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k]),(0,b.registerServerReference)(f,"4051358d725b4044b4fdbd74318bae0cb8a8202223",null),(0,b.registerServerReference)(g,"6063814e7fe3c93c0a64c2da9f1839dde3930ad582",null),(0,b.registerServerReference)(h,"404e99b8a0847028f660fbc984b5dd6745e3b9c778",null),(0,b.registerServerReference)(i,"60211aeb80c05ed8abf26656abe964d684267a3d74",null),(0,b.registerServerReference)(j,"406043f51f142c0dd818afbb66f0171427e7776683",null),(0,b.registerServerReference)(k,"00a232eb085a0951373733706b35c0c0ea07607aa5",null),a.s(["assignRole",()=>i,"createRole",()=>f,"deleteRole",()=>h,"getRoles",()=>j,"getRolesData",()=>k,"updateRole",()=>g])},40041,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558),e=a.i(54799),f=a.i(45861);async function g(a,b){let d=await (0,c.createServerClient)();if(!b){let{data:{user:a}}=await d.auth.getUser();if(!a)return[];let{data:c}=await d.from("users").select("current_profile_id").eq("id",a.id).maybeSingle();if(!c?.current_profile_id)return[];let{data:e}=await d.from("profiles").select("store_id").eq("id",c.current_profile_id).maybeSingle();if(!e?.store_id)return[];b=e.store_id}let e=d.from("profiles").select(`
            id,
            invite_token,
            store_id,
            role,
            invite_status,
            invite_expires_at,
            created_at,
            display_name,
            avatar_url
        `).eq("store_id",b).in("invite_status",["pending","accepted","canceled"]);a?.status&&(e=e.eq("invite_status",a.status)),a?.status==="pending"&&(e=e.not("invite_token","is",null).not("invite_expires_at","is",null)),a?.role&&(e=e.eq("role",a.role));let{data:f,error:g}=await e;if(g)return console.error("Error fetching invitations:",g),[];let h=f.filter(a=>"pending"!==a.invite_status||!!a.invite_expires_at).map(a=>({id:a.id,token:a.id,store_id:a.store_id,profile_id:a.id,role_id:null,status:a.invite_status,expires_at:a.invite_expires_at,created_at:a.created_at,profile:{display_name:a.display_name,avatar_url:a.avatar_url,role:a.role}}));if(a?.search){let b=a.search.toLowerCase();h=h.filter(a=>(a.profile?.display_name||"").toLowerCase().includes(b))}return h}async function h(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)return{success:!1,error:"Unauthorized"};let e=await k(a);if(!e)return{success:!1,error:"Invitation not found"};let{error:f}=await b.from("profiles").update({user_id:d.id,invite_status:"accepted",invite_token:null,invite_expires_at:null}).eq("id",e.profile_id);return f?(console.error("Error accepting invitation:",f),{success:!1,error:f.message}):{success:!0}}async function i(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();if(!f)throw Error("Unauthorized");let{data:g}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!g?.current_profile_id)throw Error("No profile found");let{data:h}=await b.from("profiles").select("store_id").eq("id",g.current_profile_id).maybeSingle();if(!h?.store_id)throw Error("No store found");let i=new Date;i.setDate(i.getDate()+a.expiresInDays);let j=null;a.password&&(j=e.default.createHash("sha256").update(a.password).digest("hex"));let{data:k,error:l}=await b.from("profiles").update({invite_status:"pending",invite_expires_at:i.toISOString(),invite_password_hash:j,role_id:a.roleId||null}).eq("id",a.profileId).select().single();if(l)throw console.error("Error creating invitation:",l),Error("Failed to create invitation");return(0,d.revalidatePath)("/app/invitations"),{success:!0,invitation:{id:k.id,token:k.id,store_id:k.store_id,profile_id:k.id,role_id:null,status:k.invite_status,expires_at:k.invite_expires_at,created_at:new Date().toISOString(),profile:{display_name:k.display_name,avatar_url:k.avatar_url,role:k.role}}}}async function j(a){let b=await (0,c.createServerClient)(),{error:e}=await b.from("profiles").update({invite_status:"canceled",invite_token:null,invite_expires_at:null}).eq("id",a);if(e)throw console.error("Error canceling invitation:",e),Error("Failed to cancel invitation");return(0,d.revalidatePath)("/app/invitations"),{success:!0}}async function k(a){let b=await (0,c.createServerClient)(),{data:d,error:e}=await b.rpc("get_profile_by_id_for_invite",{lookup_id:a});if(e||!d||0===d.length)return null;let f=d[0];return{id:f.id,token:a,store_id:f.store_id,profile_id:f.id,role_id:null,status:f.invite_status,expires_at:f.invite_expires_at,created_at:new Date().toISOString(),password_hash:f.invite_password_hash,store_name:f.store_name,profile_name:f.profile_name,has_password:!!f.invite_password_hash}}async function l(a){let b=await (0,c.createServerClient)();if(!a){let{data:{user:c}}=await b.auth.getUser();if(!c)return[];let{data:d}=await b.from("users").select("current_profile_id").eq("id",c.id).maybeSingle();if(!d?.current_profile_id)return[];let{data:e}=await b.from("profiles").select("store_id").eq("id",d.current_profile_id).maybeSingle();if(!e?.store_id)return[];a=e.store_id}let{data:d}=await b.from("profiles").select("id, display_name, role, avatar_url").eq("store_id",a).is("user_id",null);return d||[]}async function m(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};if("staff"!==e.role)return{redirect:"/app/timecard"};let h=e.store_id,[i,j,k,m]=await Promise.all([g(void 0,h),l(h),(0,f.getRoles)(h),a.from("profiles").select("id, display_name, real_name, role, created_at, approval_status").eq("store_id",h).eq("approval_status","pending").order("created_at",{ascending:!1}).then(a=>a.data||[])]);return{data:{invitations:i,uninvitedProfiles:j,roles:k,joinRequestsCount:m.length,joinRequests:m}}}async function n(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("store_id, role").eq("id",d.current_profile_id).maybeSingle();if(!e||!e.store_id)return{redirect:"/app/me"};if("staff"!==e.role)return{redirect:"/app/timecard"};let{data:f}=await a.from("profiles").select("id, display_name, real_name, role, created_at, approval_status").eq("store_id",e.store_id).eq("approval_status","pending").order("created_at",{ascending:!1});return{data:{joinRequests:f||[]}}}(0,a.i(13095).ensureServerEntryExports)([g,h,i,j,k,l,m,n]),(0,b.registerServerReference)(g,"60098d0194cb419a6fd3cf8152bc46b394969a1e7d",null),(0,b.registerServerReference)(h,"40d281ed84b38ac668808ba72195ebb5e55f757c52",null),(0,b.registerServerReference)(i,"407f73d041bbeb8a449b1a11854978deb1f2bd26db",null),(0,b.registerServerReference)(j,"40c6ac2758dfc3a203b0445eadd0044237a7643d08",null),(0,b.registerServerReference)(k,"40c628f1df5e654f322ec7aa92c201a2ef9b13090c",null),(0,b.registerServerReference)(l,"401b9edc6a21bc5fed5e321d79818fa8a31ed39a51",null),(0,b.registerServerReference)(m,"00d9e4a5cc4e76c5250a3795b040d5e078b703757f",null),(0,b.registerServerReference)(n,"00af8e2dc2f7222e26f0f54a39bfb791519379a9a2",null),a.s(["acceptInvitation",()=>h,"cancelInvitation",()=>j,"createInvitation",()=>i,"getInvitationByToken",()=>k,"getInvitations",()=>g,"getInvitationsData",()=>m,"getJoinRequestsData",()=>n,"getUninvitedProfiles",()=>l])},51839,a=>{"use strict";var b=a.i(40041),c=a.i(45861);a.s([],53461),a.i(53461),a.s(["00a232eb085a0951373733706b35c0c0ea07607aa5",()=>c.getRolesData,"00af8e2dc2f7222e26f0f54a39bfb791519379a9a2",()=>b.getJoinRequestsData,"00d9e4a5cc4e76c5250a3795b040d5e078b703757f",()=>b.getInvitationsData,"401b9edc6a21bc5fed5e321d79818fa8a31ed39a51",()=>b.getUninvitedProfiles,"404e99b8a0847028f660fbc984b5dd6745e3b9c778",()=>c.deleteRole,"4051358d725b4044b4fdbd74318bae0cb8a8202223",()=>c.createRole,"406043f51f142c0dd818afbb66f0171427e7776683",()=>c.getRoles,"407f73d041bbeb8a449b1a11854978deb1f2bd26db",()=>b.createInvitation,"40c628f1df5e654f322ec7aa92c201a2ef9b13090c",()=>b.getInvitationByToken,"40c6ac2758dfc3a203b0445eadd0044237a7643d08",()=>b.cancelInvitation,"40d281ed84b38ac668808ba72195ebb5e55f757c52",()=>b.acceptInvitation,"60098d0194cb419a6fd3cf8152bc46b394969a1e7d",()=>b.getInvitations,"60211aeb80c05ed8abf26656abe964d684267a3d74",()=>c.assignRole,"6063814e7fe3c93c0a64c2da9f1839dde3930ad582",()=>c.updateRole],51839)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__731eda0f._.js.map