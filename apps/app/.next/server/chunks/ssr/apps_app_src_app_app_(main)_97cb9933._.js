module.exports=[86519,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558),e=a.i(73918);async function f(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("User not authenticated");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No active profile found for current user");let g=a.get("profileId")??f.current_profile_id,{data:h}=await b.from("profiles").select("id, store_id").eq("id",f.current_profile_id).maybeSingle();if(!h||!h.store_id)throw Error("Current profile has no store");let{data:i}=await b.from("profiles").select("id, store_id").eq("id",g).maybeSingle();if(!i||i.store_id!==h.store_id)throw Error("Selected profile does not belong to current store");let j=a.get("date"),k=a.get("status"),l=a.get("startTime"),m=a.get("endTime"),n=a.get("pickup_destination"),o=(a,b)=>{if(!a)return null;let c=/^\d{2}:\d{2}$/.test(a)?`${a}:00`:a;return new Date(`${b}T${c}+09:00`).toISOString()},p={user_id:g,work_date:j,pickup_destination:n||null};if(l){let a=o(l,j);p.clock_in=a,p.scheduled_start_time=a}else if("working"===k||"finished"===k){let a=new Date(`${j}T00:00:00+09:00`).toISOString();p.clock_in=a,p.scheduled_start_time=a}else p.clock_in=null,p.scheduled_start_time=null;if(m){let a=o(m,j);p.clock_out=a,p.scheduled_end_time=a}else if("finished"===k){let a=new Date(`${j}T23:59:59+09:00`).toISOString();p.clock_out=a,p.scheduled_end_time=a}else p.clock_out=null,p.scheduled_end_time=null;let{error:q}=await b.from("time_cards").insert(p);if(q)throw console.error("Error creating time card:",q),console.error("Error details:",JSON.stringify(q,null,2)),Error(`Failed to create time card: ${q.message||JSON.stringify(q)}`);return console.log("Time card created successfully!"),(0,d.revalidatePath)("/app/attendance"),{success:!0}}async function g(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("User not authenticated");let f=a.get("id"),g=a.get("profileId"),h=a.get("date"),i=a.get("status"),j=a.get("startTime"),k=a.get("endTime"),l=a.get("pickup_destination");if(!f)throw Error("Time card id is required");let{data:m}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!m?.current_profile_id)throw Error("No active profile found for current user");let{data:n}=await b.from("profiles").select("id, store_id").eq("id",m.current_profile_id).maybeSingle();if(!n||!n.store_id)throw Error("Current profile has no store");if(g){let{data:a}=await b.from("profiles").select("id, store_id").eq("id",g).maybeSingle();if(!a||a.store_id!==n.store_id)throw Error("Selected profile does not belong to current store")}let o=(a,b)=>{if(!a)return null;let c=/^\d{2}:\d{2}$/.test(a)?`${a}:00`:a;return new Date(`${b}T${c}+09:00`).toISOString()},p={user_id:g||m.current_profile_id,work_date:h,pickup_destination:l||null};if(j){let a=o(j,h);p.clock_in=a,p.scheduled_start_time=a}else if("working"===i||"finished"===i){let a=new Date(`${h}T00:00:00+09:00`).toISOString();p.clock_in=a,p.scheduled_start_time=a}else p.clock_in=null,p.scheduled_start_time=null;if(k){let a=o(k,h);p.clock_out=a,p.scheduled_end_time=a}else if("finished"===i){let a=new Date(`${h}T23:59:59+09:00`).toISOString();p.clock_out=a,p.scheduled_end_time=a}else p.clock_out=null,p.scheduled_end_time=null;let{error:q}=await b.from("time_cards").update(p).eq("id",f);if(q)throw console.error("Error updating time card:",q),console.error("Error details:",JSON.stringify(q,null,2)),Error(`Failed to update time card: ${q.message||JSON.stringify(q)}`);return(0,d.revalidatePath)("/app/attendance"),{success:!0}}async function h(a){let b=a.get("file");if(!b)throw Error("CSVファイルが指定されていません");let e=a.get("attendanceRole")??null,f=await (0,c.createServerClient)(),{data:{user:g}}=await f.auth.getUser();if(!g)throw Error("User not authenticated");let{data:h}=await f.from("users").select("current_profile_id").eq("id",g.id).maybeSingle();if(!h?.current_profile_id)throw Error("No active profile found for current user");let{data:i}=await f.from("profiles").select("store_id").eq("id",h.current_profile_id).maybeSingle();if(!i?.store_id)throw Error("Current profile has no store");let{data:j}=await f.from("profiles").select("id, display_name, role").eq("store_id",i.store_id),k=new Map;for(let a of j||[]){let b=a.display_name?.trim().toLowerCase();if(!b)continue;let c=a.role;("cast"!==e||"cast"===c)&&("staff"!==e||"staff"===c)&&(k.has(b)?k.set(b,null):k.set(b,a.id))}let l=(await b.text()).split(/\r?\n/).map(a=>a.trim()).filter(a=>a.length>0);if(l.length<2)throw Error("CSVに有効なデータ行がありません");let m=l[0].split(",").map(a=>a.trim()),n={display_name:m.indexOf("display_name"),date:m.indexOf("date"),status:m.indexOf("status"),start_time:m.indexOf("start_time"),end_time:m.indexOf("end_time")};if(-1===n.display_name||-1===n.date||-1===n.status)throw Error("CSVヘッダーに display_name, date, status カラムが必要です");let o=a=>{let b=(a||"").trim();return b?/^\d{2}:\d{2}$/.test(b)?`${b}:00`:/^\d{2}:\d{2}:\d{2}$/.test(b)?b:null:null},p=[];for(let a=1;a<l.length;a++){let b=l[a].split(","),c=(b[n.display_name]||"").trim(),d=(b[n.date]||"").trim(),e=(b[n.status]||"").trim();if(!c||!d||!e)continue;let f=c.toLowerCase(),g=k.get(f);if(!g)continue;let h=-1!==n.start_time?b[n.start_time]:void 0,i=-1!==n.end_time?b[n.end_time]:void 0,j={user_id:g,work_date:d};if("working"===e||"finished"===e){let a=o(h);j.clock_in=a?new Date(`${d}T${a}`).toISOString():new Date(`${d}T00:00:00`).toISOString()}else j.clock_in=null;if("finished"===e){let a=o(i);j.clock_out=a?new Date(`${d}T${a}`).toISOString():new Date(`${d}T23:59:59`).toISOString()}else j.clock_out=null;p.push(j)}if(0===p.length)return void(0,d.revalidatePath)("/app/attendance");let{error:q}=await f.from("time_cards").insert(p);if(q)throw console.error("Error importing time cards from CSV:",q),console.error("Error details:",JSON.stringify(q,null,2)),Error("CSVのインポート中にエラーが発生しました");(0,d.revalidatePath)("/app/attendance")}async function i(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("User not authenticated");let{data:e,error:f}=await b.from("time_cards").select("*").eq("user_id",a).order("work_date",{ascending:!1});if(f)throw console.error("Error fetching attendance records:",f),Error("勤怠履歴の取得に失敗しました");return e}async function j(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)return{redirect:"/login"};let{data:f}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle();if(!f?.current_profile_id)return{redirect:"/app/me"};let{data:g}=await b.from("profiles").select("id, store_id, role, stores(*)").eq("id",f.current_profile_id).maybeSingle();if(!g||!g.store_id)return{redirect:"/app/me"};let h=g.stores;if(h&&!1===h.show_attendance||"staff"!==g.role)return{redirect:"/app/timecard"};let{data:i,error:j}=await b.from("profiles").select("id, display_name, real_name, role, store_id").eq("store_id",g.store_id);j&&console.error("Error fetching store profiles:",j);let k=i||[],l={},m=[];for(let a of k)l[a.id]=a,m.push(a.id);let n=(0,e.createServiceRoleClient)(),o=new Date,p=new Date;p.setDate(o.getDate()-30);let q=p.toISOString().split("T")[0],r=[];if(m.length>0){let{data:a,error:b}=await n.from("time_cards").select("id, user_id, work_date, clock_in, clock_out, scheduled_start_time, scheduled_end_time, forgot_clockout, pickup_destination").in("user_id",m).gte("work_date",q).order("work_date",{ascending:!1});b?console.error("Error fetching time cards for attendance:",b):(r=(a||[]).map(a=>{let b="scheduled";a.forgot_clockout?b="forgot_clockout":a.clock_out?b="finished":a.clock_in&&(b="working");let c=a=>{if(!a)return null;let b=new Date(a),c=String(b.getHours()).padStart(2,"0"),d=String(b.getMinutes()).padStart(2,"0");return`${c}:${d}`},d=l[a.user_id];return{id:a.id,user_id:a.user_id,date:a.work_date,name:d?d.display_name:"不明",status:b,start_time:c(a.scheduled_start_time||a.clock_in),end_time:c(a.scheduled_end_time||a.clock_out),clock_in:c(a.clock_in),clock_out:c(a.clock_out),pickup_destination:a.pickup_destination}})).sort((a,b)=>{if(a.date!==b.date)return b.date.localeCompare(a.date);let c=a.clock_in||"";return(b.clock_in||"").localeCompare(c)})}return{data:{allRecords:r,allProfiles:k,roleFilter:"staff"===a?"staff":"cast"}}}async function k(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("User not authenticated");if(!a)throw Error("Time card id is required");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No active profile found for current user");let{data:g}=await b.from("profiles").select("id, store_id").eq("id",f.current_profile_id).maybeSingle();if(!g||!g.store_id)throw Error("Current profile has no store");let{data:h}=await b.from("time_cards").select("user_id").eq("id",a).maybeSingle();if(!h)throw Error("Time card not found");let{data:i}=await b.from("profiles").select("store_id").eq("id",h.user_id).maybeSingle();if(!i||i.store_id!==g.store_id)throw Error("Cannot delete time card from another store");let{error:j}=await b.from("time_cards").delete().eq("id",a);if(j)throw console.error("Error deleting time card:",j),Error("Failed to delete time card");return(0,d.revalidatePath)("/app/attendance"),{success:!0}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k]),(0,b.registerServerReference)(f,"403be324e96604b07e3d40e85ad9ed05510f775e95",null),(0,b.registerServerReference)(g,"405bcd64a4bdfaf384e28eef70d6feb4dab0c1c2a1",null),(0,b.registerServerReference)(h,"40edcbef1d6c1f791376c68f39157c743fb964f1f0",null),(0,b.registerServerReference)(i,"4045f18647982ea20967cf125e0fa243b6327117e9",null),(0,b.registerServerReference)(j,"403b5d2cdfed4f062a7f1c9f4769bfca09a50cdc5a",null),(0,b.registerServerReference)(k,"40d39c086fd86461c7bae6b63e57f6f4ac6ba7b97d",null),a.s(["createAttendance",()=>f,"deleteAttendance",()=>k,"getAttendanceData",()=>j,"getAttendanceRecords",()=>i,"importAttendanceFromCsv",()=>h,"updateAttendance",()=>g])},94239,a=>{"use strict";var b=a.i(37936),c=a.i(9480);a.i(70396);var d=a.i(73727),e=a.i(18558);async function f(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();f||(0,d.redirect)("/login");let g=a.get("displayName"),h=a.get("displayNameKana")?.trim()||null,i=a.get("realName"),j=a.get("realNameKana"),k=a.get("role"),l=a.get("guestAddressee")?.trim()||null,m=a.get("guestReceiptType")??"none",n=["none","amount_only","with_date"].includes(m)?m:"none";if(!g||!k)throw Error("必須項目が入力されていません");let{data:o}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!o?.current_profile_id)throw Error("店舗情報が見つかりません");let{data:p}=await b.from("profiles").select("store_id").eq("id",o.current_profile_id).maybeSingle();if(!p?.store_id)throw Error("店舗情報が見つかりません");let{error:q}=await b.from("profiles").insert({display_name:g,display_name_kana:h,real_name:i,real_name_kana:j,role:k,store_id:p.store_id,user_id:null,guest_addressee:"guest"===k?l:null,guest_receipt_type:"guest"===k?n:"none"});if(q)throw console.error("Error creating user:",q),Error(`ユーザーの作成に失敗しました: ${q.message}`);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function g(a){let b=a.get("file");if(!b)throw Error("CSVファイルが指定されていません");let f=a.get("userRole")??null,g=await (0,c.createServerClient)(),{data:{user:h}}=await g.auth.getUser();h||(0,d.redirect)("/login");let{data:i}=await g.from("users").select("current_profile_id").eq("id",h.id).maybeSingle();if(!i?.current_profile_id)throw Error("店舗情報が見つかりません");let{data:j}=await g.from("profiles").select("store_id").eq("id",i.current_profile_id).maybeSingle();if(!j?.store_id)throw Error("店舗情報が見つかりません");let k=(await b.text()).split(/\r?\n/).map(a=>a.trim()).filter(a=>a.length>0);if(k.length<2)throw Error("CSVに有効なデータ行がありません");let l=k[0].split(",").map(a=>a.trim()),m={display_name:l.indexOf("display_name"),display_name_kana:l.indexOf("display_name_kana"),real_name:l.indexOf("real_name"),real_name_kana:l.indexOf("real_name_kana"),role:l.indexOf("role")};if(-1===m.display_name)throw Error("CSVヘッダーに display_name カラムが必要です");if(-1===m.role&&!f)throw Error("role カラムが存在しない場合は、インポートするロールを画面で選択してください");let{data:n}=await g.from("profiles").select("display_name, display_name_kana").eq("store_id",j.store_id),o=new Set((n||[]).map(a=>a.display_name?.trim().toLowerCase()).filter(a=>!!a)),p=[];for(let a=1;a<k.length;a++){let b=k[a].split(","),c=(b[m.display_name]||"").trim(),d=-1!==m.role?(b[m.role]||"").trim():"",e=f||d;if(!c||!e)continue;let g=c.toLowerCase();if(o.has(g))continue;let h=-1!==m.display_name_kana?(b[m.display_name_kana]||"").trim():"",i=-1!==m.real_name?(b[m.real_name]||"").trim():"",l=-1!==m.real_name_kana?(b[m.real_name_kana]||"").trim():"";p.push({display_name:c,display_name_kana:h||null,real_name:i,real_name_kana:l,role:e,store_id:j.store_id,user_id:null}),o.add(g)}if(0===p.length)return void(0,e.revalidatePath)("/app/users");let{error:q}=await g.from("profiles").insert(p);if(q)throw console.error("Error importing users from CSV:",q),Error("CSVのインポート中にエラーが発生しました");(0,e.revalidatePath)("/app/users")}async function h(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();f||(0,d.redirect)("/login");let g=a.get("profileId"),h=a.get("displayName"),i=a.get("displayNameKana")?.trim()||null,j=a.get("realName")??"",k=a.get("realNameKana")??"",l=a.get("role"),m=a.get("guestAddressee")?.trim()||null,n=a.get("guestReceiptType")??"none",o=["none","amount_only","with_date"].includes(n)?n:"none";if(!g||!h||!l)throw Error("必須項目が入力されていません");let{data:p}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!p?.current_profile_id)throw Error("店舗情報が見つかりません");let{data:q}=await b.from("profiles").select("store_id, role, role_id").eq("id",p.current_profile_id).maybeSingle();if(!q?.store_id)throw Error("店舗情報が見つかりません");if("staff"===q.role&&"staff"!==l){let{count:a,error:c}=await b.from("profiles").select("*",{count:"exact",head:!0}).eq("store_id",q.store_id).eq("role","staff");if(c)throw console.error("Error checking admin count:",c),Error("管理者数の確認に失敗しました");if(null!==a&&a<=1)throw Error("店舗には少なくとも1人のスタッフが必要です")}if(q.role_id){let{data:a}=await b.from("store_roles").select("name, is_system_role").eq("id",q.role_id).single();if(a?.name==="スタッフ"&&a?.is_system_role){let{count:a}=await b.from("profiles").select("*",{count:"exact",head:!0}).eq("store_id",q.store_id).eq("role_id",q.role_id);if(null!==a&&a<=1&&"staff"!==l)throw Error("店舗には少なくとも1人のスタッフが必要です")}}let{error:r}=await b.from("profiles").update({display_name:h,display_name_kana:i,real_name:j,real_name_kana:k,role:l,guest_addressee:"guest"===l?m:null,guest_receipt_type:"guest"===l?o:"none"}).eq("id",g).eq("store_id",q.store_id);if(r)throw console.error("Error updating user:",r),Error(`ユーザーの更新に失敗しました: ${r.message}`);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function i(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("User not authenticated");let{data:f}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle();if(!f?.current_profile_id)throw Error("No active profile found for current user");let{data:g}=await b.from("profiles").select("store_id, role").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("店舗情報が見つかりません");let{data:h}=await b.from("profiles").select("store_id").eq("id",a).maybeSingle();if(!h)throw Error("ユーザーが見つかりません");if(h.store_id!==g.store_id)throw Error("権限がありません");let{error:i}=await b.from("profiles").delete().eq("id",a);if(i)throw console.error("Error deleting user:",i),Error(`ユーザーの削除に失敗しました: ${i.message}`);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function j(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)return null;let{data:e}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle(),f=e?.current_profile_id,{data:g,error:h}=await b.from("profile_relationships").select("*").or(`source_profile_id.eq.${a},target_profile_id.eq.${a}`);if(h)return console.error("Error fetching relationships:",h),null;let{data:i,error:j}=await b.from("profile_comments").select(`
            *,
            author:profiles!author_profile_id (
                id,
                display_name,
                avatar_url
            )
        `).eq("target_profile_id",a).order("updated_at",{ascending:!1});if(j)return console.error("Error fetching comments:",j),null;if(!i||0===i.length)return{relationships:g||[],comments:[]};let k=i.map(a=>a.id),{data:l}=await b.from("profile_comment_likes").select("comment_id, profile_id").in("comment_id",k),m=new Map;return k.forEach(a=>{let b=l?.filter(b=>b.comment_id===a)||[];m.set(a,{count:b.length,userHasLiked:b.some(a=>a.profile_id===f)})}),{relationships:g||[],comments:i.map(a=>{let b=m.get(a.id)||{count:0,userHasLiked:!1};return{...a,like_count:b.count,user_has_liked:b.userHasLiked}})}}async function k(a,b,d){let f=await (0,c.createServerClient)(),{data:{user:g}}=await f.auth.getUser();if(!g)throw Error("Unauthorized");let{data:h}=await f.from("users").select("current_profile_id").eq("id",g.id).maybeSingle();if(!h?.current_profile_id)throw Error("No profile");let{data:i}=await f.from("profiles").select("store_id").eq("id",h.current_profile_id).maybeSingle();if(!i?.store_id)throw Error("No store");let{data:j,error:k}=await f.from("profile_relationships").select("*").eq("relationship_type",b).or(`source_profile_id.eq.${a},target_profile_id.eq.${a}`);if(k)throw Error(k.message);let l=new Set(j?.map(b=>b.source_profile_id===a?b.target_profile_id:b.source_profile_id)),m=new Set(d),n=d.filter(a=>!l.has(a)),o=Array.from(l).filter(a=>!m.has(a));if(o.length>0){let b=j?.filter(b=>o.includes(b.source_profile_id===a?b.target_profile_id:b.source_profile_id)).map(a=>a.id);if(b&&b.length>0){let{error:a}=await f.from("profile_relationships").delete().in("id",b);if(a)throw Error(a.message)}}if(n.length>0){let c=n.map(c=>{let[d,e]=[a,c].sort();return{store_id:i.store_id,source_profile_id:d,target_profile_id:e,relationship_type:b}}),{error:d}=await f.from("profile_relationships").insert(c);if(d)throw Error(d.message)}return(0,e.revalidatePath)("/app/users"),{success:!0}}async function l(a,b){let d=await (0,c.createServerClient)(),{data:{user:f}}=await d.auth.getUser();if(!f)throw Error("Unauthorized");let{data:g}=await d.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!g?.current_profile_id)throw Error("No profile");let{data:h}=await d.from("profiles").select("store_id").eq("id",g.current_profile_id).maybeSingle();if(!h?.store_id)throw Error("No store");let{error:i}=await d.from("profile_comments").insert({store_id:h.store_id,target_profile_id:a,author_profile_id:g.current_profile_id,content:b});if(i)throw Error(i.message);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function m(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return[];let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return[];let{data:e}=await a.from("profiles").select("store_id").eq("id",d.current_profile_id).maybeSingle();if(!e?.store_id)return[];let{data:f}=await a.from("profiles").select("id, display_name, real_name, role, avatar_url").eq("store_id",e.store_id).order("display_name");return f||[]}async function n(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return null;let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();return d?.current_profile_id||null}async function o(a,b){let d=await (0,c.createServerClient)(),{data:{user:f}}=await d.auth.getUser();if(!f)throw Error("Unauthorized");let{data:g}=await d.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();if(!g?.current_profile_id)throw Error("No profile");let{data:h}=await d.from("profile_comments").select("author_profile_id").eq("id",a).maybeSingle();if(!h||h.author_profile_id!==g.current_profile_id)throw Error("Unauthorized");let{error:i}=await d.from("profile_comments").update({content:b,updated_at:new Date().toISOString()}).eq("id",a);if(i)throw Error(i.message);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function p(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile");let{data:g}=await b.from("profile_comments").select("author_profile_id").eq("id",a).maybeSingle();if(!g||g.author_profile_id!==f.current_profile_id)throw Error("Unauthorized");let{error:h}=await b.from("profile_comments").delete().eq("id",a);if(h)throw Error(h.message);return(0,e.revalidatePath)("/app/users"),{success:!0}}async function q(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile");let{data:g}=await b.from("profile_comment_likes").select("id").eq("comment_id",a).eq("profile_id",f.current_profile_id).maybeSingle();if(g){let{error:a}=await b.from("profile_comment_likes").delete().eq("id",g.id);if(a)throw Error(a.message)}else{let{error:c}=await b.from("profile_comment_likes").insert({comment_id:a,profile_id:f.current_profile_id});if(c)throw Error(c.message)}return(0,e.revalidatePath)("/app/users"),{success:!0}}async function r(a,b){let d=await (0,c.createServerClient)(),{data:{user:e}}=await d.auth.getUser();if(!e)return{redirect:"/login"};let{data:f}=await d.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)return{redirect:"/app/me"};let{data:g}=await d.from("profiles").select("id, store_id, role, stores(*)").eq("id",f.current_profile_id).maybeSingle();if(!g||!g.store_id)return{redirect:"/app/me"};if("staff"!==g.role)return{redirect:"/app/timecard"};let h=d.from("profiles").select("id, display_name, display_name_kana, real_name, real_name_kana, role, avatar_url, guest_addressee, guest_receipt_type").eq("store_id",g.store_id).eq("role",a||"cast").order("display_name");b&&(h=h.or(`display_name.ilike.%${b}%,display_name_kana.ilike.%${b}%,real_name.ilike.%${b}%,real_name_kana.ilike.%${b}%`));let{data:i,error:j}=await h;return j?(console.error("Error fetching users:",j),{data:{users:[]}}):{data:{users:i||[]}}}async function s(a){let b=await (0,c.createServerClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)return[];let{data:e}=await b.from("users").select("current_profile_id").eq("id",d.id).maybeSingle();if(!e?.current_profile_id)return[];let{data:f}=await b.from("profiles").select("store_id").eq("id",e.current_profile_id).maybeSingle();if(!f?.store_id)return[];let{data:g}=await b.from("profiles").select("store_id").eq("id",a).maybeSingle();if(!g||g.store_id!==f.store_id)return[];let{data:h,error:i}=await b.from("bottle_keep_holders").select(`
            bottle_keep_id,
            bottle_keeps (
                id,
                menu_id,
                opened_at,
                expiration_date,
                remaining_amount,
                status,
                memo,
                menus (
                    name,
                    price
                )
            )
        `).eq("profile_id",a);return i?(console.error("Error fetching user bottle keeps:",i),[]):h?.map(a=>a.bottle_keeps).filter(a=>a&&"active"===a.status).map(a=>({...a,menu_name:a.menus?.name||"不明なボトル",menu_price:a.menus?.price||0}))||[]}async function t(a,b){let d=await (0,c.createServerClient)(),f=b.get("file");if(!f)throw Error("ファイルが選択されていません");let g=f.name.split(".").pop(),h=`${a}-${Date.now()}.${g}`,i=`${h}`,{error:j}=await d.storage.from("avatars").upload(i,f);if(j)throw console.error("Upload error:",j),Error(`アップロードに失敗しました: ${j.message}`);let{data:{publicUrl:k}}=d.storage.from("avatars").getPublicUrl(i),{error:l}=await d.from("profiles").update({avatar_url:k}).eq("id",a);if(l)throw console.error("Update error:",l),Error(`プロフィールの更新に失敗しました: ${l.message}`);return(0,e.revalidatePath)("/app/users"),{success:!0,publicUrl:k}}async function u(a){let b=await (0,c.createServerClient)(),{data:d}=await b.from("profiles").select("avatar_url").eq("id",a).single();if(d?.avatar_url){let a=new URL(d.avatar_url).pathname.split("/").pop();a&&await b.storage.from("avatars").remove([a])}let{error:f}=await b.from("profiles").update({avatar_url:null}).eq("id",a);if(f)throw Error(`削除に失敗しました: ${f.message}`);return(0,e.revalidatePath)("/app/users"),{success:!0}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u]),(0,b.registerServerReference)(f,"40e631752d3f63866f4bfdcefb52b39b7a16b9beed",null),(0,b.registerServerReference)(g,"40b6eb95e9b6c0ba061867541804e0f623d876c940",null),(0,b.registerServerReference)(h,"40d54faf838f60a57d913423bb21d98cd0140e82a1",null),(0,b.registerServerReference)(i,"40d454b66dc7597bde21ab5ab88ac6c1291aba3456",null),(0,b.registerServerReference)(j,"40ac9d7a98c2a78cd988100eef4e5e7d91131859e8",null),(0,b.registerServerReference)(k,"7013ab3c5d7056545e992425288ac07f894e0f9321",null),(0,b.registerServerReference)(l,"6037218bf15dafe2b6f4a84653a7896a5f707e4376",null),(0,b.registerServerReference)(m,"00e8e4d5ad38b65a60a88324e02b1556aaf771095a",null),(0,b.registerServerReference)(n,"00a5fe1c9ebf4b8eac0bfb2ac26badbfac17290c2b",null),(0,b.registerServerReference)(o,"60819da50ce93994448e38298ecedf8232cced91bd",null),(0,b.registerServerReference)(p,"4084b6043912cd8a75569f2d971d9e162ea4de2c3f",null),(0,b.registerServerReference)(q,"405a3002f6f21537774442b0b95e2dd58bbb99e2d9",null),(0,b.registerServerReference)(r,"60ba2e83cd4c6747363b9276e7e4135fff4dbfa046",null),(0,b.registerServerReference)(s,"405d88bef58e495845168b770b6ef6545da02343bd",null),(0,b.registerServerReference)(t,"6032599c457d1d9c38a767c7a62a3e4304032c930b",null),(0,b.registerServerReference)(u,"40a7d24dbb5a7d9dfb1a862bc601d5443013a95d2a",null),a.s(["addProfileComment",()=>l,"createUser",()=>f,"deleteProfileAvatar",()=>u,"deleteProfileComment",()=>p,"deleteUser",()=>i,"getAllProfiles",()=>m,"getCurrentUserProfileId",()=>n,"getProfileDetails",()=>j,"getUserBottleKeeps",()=>s,"getUsersData",()=>r,"importUsersFromCsv",()=>g,"toggleCommentLike",()=>q,"updateProfileComment",()=>o,"updateProfileRelationships",()=>k,"updateUser",()=>h,"uploadProfileAvatar",()=>t])}];

//# sourceMappingURL=apps_app_src_app_app_%28main%29_97cb9933._.js.map