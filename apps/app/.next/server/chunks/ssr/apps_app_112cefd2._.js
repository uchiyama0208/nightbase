module.exports=[12095,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);a.i(70396);var e=a.i(73727);async function f(a){let b=a.get("storeName"),f=a.get("profileDisplayName")??null,g=await (0,c.createServerClient)(),{data:{user:h}}=await g.auth.getUser();if(!h)throw Error("User not authenticated");if(!b)throw Error("Store name is required");let{data:i,error:j}=await g.from("stores").insert({name:b}).select().single();if(j)throw console.error("Error creating store:",j),Error("Failed to create store");let{data:k,error:l}=await g.from("profiles").insert({user_id:h.id,store_id:i.id,role:"admin",display_name:f&&f.trim().length>0?f.trim():"Admin"}).select().single();if(l||!k)throw console.error("Error creating profile:",l),await g.from("stores").delete().eq("id",i.id),Error("Failed to create profile");let{error:m}=await g.from("users").upsert({id:h.id,email:h.email??null,current_profile_id:k.id},{onConflict:"id"});m&&console.error("Error setting current_profile_id on users:",m),(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/dashboard"),(0,d.revalidatePath)("/app/(main)","layout"),(0,e.redirect)("/app/settings")}async function g(){let a=await (0,c.createServerClient)();await a.auth.signOut(),(0,e.redirect)("/login")}async function h(a){let b="on"===a.get("showBreakColumns"),e="on"===a.get("tabletTimecardEnabled"),f=a.get("tabletAcceptanceStartTime"),g=a.get("tabletAcceptanceEndTime"),h=a.getAll("tabletAllowedRoles"),i=a.get("tabletTheme"),j="on"===a.get("locationCheckEnabled"),k=a.get("latitude")?parseFloat(a.get("latitude")):null,l=a.get("longitude")?parseFloat(a.get("longitude")):null,m=a.get("locationRadius")?parseInt(a.get("locationRadius")):50,n="on"===a.get("timeRoundingEnabled"),o=a.get("timeRoundingMethod"),p=a.get("timeRoundingMinutes")?parseInt(a.get("timeRoundingMinutes")):15,q="on"===a.get("autoClockoutEnabled"),r=await (0,c.createServerClient)(),{data:{user:s}}=await r.auth.getUser();if(!s)throw Error("User not authenticated");let{data:t,error:u}=await r.from("profiles").select("store_id").eq("user_id",s.id).maybeSingle();if(u)throw console.error("Error fetching profile for timecard settings:",u),Error("Failed to fetch profile for timecard settings");if(!t?.store_id)throw Error("Store not found for current user");let v={show_break_columns:b,tablet_timecard_enabled:e,location_check_enabled:j,latitude:k,longitude:l,location_radius:m,time_rounding_enabled:n,time_rounding_method:o||"round",time_rounding_minutes:p,auto_clockout_enabled:q};e&&(v.tablet_acceptance_start_time=f||null,v.tablet_acceptance_end_time=g||null,v.tablet_allowed_roles=h.length>0?h:["staff","cast"],v.tablet_theme=i||"light");let{error:w}=await r.from("stores").update(v).eq("id",t.store_id);if(w)throw console.error("Error updating store timecard settings:",w),Error("Failed to update timecard settings");(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/settings/timecard"),(0,d.revalidatePath)("/app/timecard"),(0,d.revalidatePath)(`/tablet/timecard/${t.store_id}`)}async function i(a){let b="on"===a.get("show_dashboard"),f="on"===a.get("show_attendance"),g="on"===a.get("show_timecard"),h="on"===a.get("show_users"),i="on"===a.get("show_roles"),j=await (0,c.createServerClient)(),{data:{user:k}}=await j.auth.getUser();if(!k)throw Error("User not authenticated");let{data:l,error:m}=await j.from("profiles").select("store_id").eq("user_id",k.id).maybeSingle();if(m)throw console.error("Error fetching profile for feature settings:",m),Error("Failed to fetch profile for feature settings");if(!l?.store_id)throw Error("Store not found for current user");let{error:n}=await j.from("stores").update({show_dashboard:b,show_attendance:f,show_timecard:g,show_users:h,show_roles:i}).eq("id",l.store_id);if(n)throw console.error("Error updating feature settings:",n),Error("Failed to update feature settings");(0,d.revalidatePath)("/app/settings"),(0,d.revalidatePath)("/app/dashboard"),(0,d.revalidatePath)("/app/attendance"),(0,d.revalidatePath)("/app/users"),(0,d.revalidatePath)("/app/roles"),(0,d.revalidatePath)("/app/(main)","layout"),(0,d.revalidatePath)("/app/features"),(0,e.redirect)("/app/features")}async function j(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();f||(0,e.redirect)("/login");let{data:g}=await b.from("users").select("current_profile_id").eq("id",f.id).maybeSingle();g?.current_profile_id||(0,e.redirect)("/app/me");let{data:h}=await b.from("profiles").select("store_id, role").eq("id",g.current_profile_id).maybeSingle();if(h&&h.store_id||(0,e.redirect)("/app/me"),"staff"!==h.role)throw Error(`Unauthorized: Current role is '${h.role}'`);let i=a.get("name"),j=a.get("business_start_time"),k=a.get("business_end_time"),l=a.get("day_switch_time"),m=a.get("industry"),n=a.get("prefecture"),o=a.getAll("closed_days"),p="on"===a.get("allow_join_requests");await b.from("stores").update({name:i,business_start_time:j||null,business_end_time:k||null,day_switch_time:l||null,industry:m||null,prefecture:n||null,closed_days:o.length>0?o:null,allow_join_requests:p,updated_at:new Date().toISOString()}).eq("id",h.store_id),(0,d.revalidatePath)("/app/settings/store"),(0,e.redirect)("/app/settings/store")}async function k(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("User not authenticated");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile found");let{error:g}=await b.from("profiles").update({theme:a}).eq("id",f.current_profile_id);if(g)throw console.error("Error updating theme:",g),Error("Failed to update theme");(0,d.revalidatePath)("/","layout")}async function l(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)return{redirect:"/login"};let{data:d}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!d?.current_profile_id)return{redirect:"/app/me"};let{data:e}=await a.from("profiles").select("*, stores(*)").eq("id",d.current_profile_id).maybeSingle();return e&&e.store_id?"staff"!==e.role?{redirect:"/app/timecard"}:{success:!0}:{redirect:"/app/me"}}async function m(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:f}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile found");let{data:g}=await a.from("profiles").select("store_id, role").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("No store found");if("staff"!==g.role)throw Error(`Insufficient permissions: Current role is '${g.role}'`);let{error:h}=await a.from("stores").delete().eq("id",g.store_id);if(h)throw console.error("Error deleting store:",h),Error("Failed to delete store");await a.from("users").update({current_profile_id:null}).eq("id",b.id),(0,d.revalidatePath)("/","layout"),(0,e.redirect)("/app/me")}async function n(a){let b=await (0,c.createServerClient)(),{data:{user:e}}=await b.auth.getUser();if(!e)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",e.id).maybeSingle();if(!f?.current_profile_id)throw Error("No profile");let{data:g}=await b.from("profiles").select("store_id, role").eq("id",f.current_profile_id).maybeSingle();if(!g?.store_id)throw Error("No store");if("staff"!==g.role)throw Error(`Unauthorized: Current role is '${g.role}'`);let h=a.get("file");if(!h)throw Error("ファイルが選択されていません");let i=h.name.split(".").pop(),j=`store-${g.store_id}-${Date.now()}.${i}`,k=`store-icons/${j}`,{error:l}=await b.storage.from("avatars").upload(k,h);if(l)throw Error(`アップロードに失敗しました: ${l.message}`);let{data:{publicUrl:m}}=b.storage.from("avatars").getPublicUrl(k),{error:n}=await b.from("stores").update({icon_url:m}).eq("id",g.store_id);if(n)throw Error(`更新に失敗しました: ${n.message}`);return(0,d.revalidatePath)("/app/settings/store"),{success:!0,publicUrl:m}}async function o(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:e}=await a.from("users").select("current_profile_id").eq("id",b.id).maybeSingle();if(!e?.current_profile_id)throw Error("No profile");let{data:f}=await a.from("profiles").select("store_id, role").eq("id",e.current_profile_id).maybeSingle();if(!f?.store_id)throw Error("No store");if("staff"!==f.role)throw Error(`Unauthorized: Current role is '${f.role}'`);let{data:g}=await a.from("stores").select("icon_url").eq("id",f.store_id).single();if(g?.icon_url){let b=new URL(g.icon_url),c=`store-icons/${b.pathname.split("/").pop()}`;await a.storage.from("avatars").remove([c])}let{error:h}=await a.from("stores").update({icon_url:null}).eq("id",f.store_id);if(h)throw Error(`削除に失敗しました: ${h.message}`);return(0,d.revalidatePath)("/app/settings/store"),{success:!0}}(0,a.i(13095).ensureServerEntryExports)([f,g,h,i,j,k,l,m,n,o]),(0,b.registerServerReference)(f,"405c7cfb7acf03ff32fbbb80b7519d602d9c21f819",null),(0,b.registerServerReference)(g,"00642b6ba2fcfa7262834fb54abfd4a10b7fd12d56",null),(0,b.registerServerReference)(h,"40341d408f028c7c9e09e5718db53f79f7665ac28c",null),(0,b.registerServerReference)(i,"40fa5639615fcc2f608746959cf859a32c49629715",null),(0,b.registerServerReference)(j,"405876b122190683f26917671ae7068209f3aa4158",null),(0,b.registerServerReference)(k,"40627c04ddfab389b3c9a4913a69a6119f43db382a",null),(0,b.registerServerReference)(l,"005003103cf9137765c8b83fa0bcc8d85ef626e4fa",null),(0,b.registerServerReference)(m,"00a3ece0f08af191db378518d182c60ae58e5644ab",null),(0,b.registerServerReference)(n,"401480709320f02adfc2c53fe10d5e53c5f50c595f",null),(0,b.registerServerReference)(o,"00d692a8991a77d14a953f671fadf7ca43ce78a0e6",null),a.s(["createStore",()=>f,"deleteStore",()=>m,"deleteStoreIcon",()=>o,"getSettingsData",()=>l,"signOut",()=>g,"updateFeatureSettings",()=>i,"updateStore",()=>j,"updateTheme",()=>k,"updateTimecardSettings",()=>h,"uploadStoreIcon",()=>n])},73918,a=>{"use strict";var b=a.i(93662),c=a.i(56793);function d(){let{supabaseUrl:a}=(0,c.getSupabaseConfig)(),d=(0,c.ensureEnv)("SUPABASE_SERVICE_ROLE_KEY",process.env.SUPABASE_SERVICE_ROLE_KEY);return(0,b.createClient)(a,d,{auth:{persistSession:!1,autoRefreshToken:!1},global:{fetch}})}a.s(["createServiceRoleClient",()=>d])},83707,a=>{"use strict";var b=a.i(37936),c=a.i(9480),d=a.i(18558);a.i(70396);var e=a.i(73727),f=a.i(73918);async function g(a){let b=await (0,c.createServerClient)(),{data:{user:f}}=await b.auth.getUser();if(!f)throw Error("User not authenticated");let{data:g}=await b.from("profiles").select("id").eq("id",a).eq("user_id",f.id).single();if(!g)throw Error("Profile not found or does not belong to user");let{error:h}=await b.from("users").update({current_profile_id:a}).eq("id",f.id);if(h)throw console.error("Error switching profile:",h),Error("Failed to switch profile");(0,d.revalidatePath)("/","layout"),(0,e.redirect)("/app/dashboard")}async function h(){let a=await (0,c.createServerClient)();await a.auth.signOut(),(0,e.redirect)("/login")}async function i(){let a,b=await (0,c.createServerClient)(),{data:{user:d},error:e}=await b.auth.getUser();if(e||!d)throw Error("Unauthorized");let{data:f}=await b.from("users").select("current_profile_id").eq("id",d.id).single();if(f?.current_profile_id){let{data:c}=await b.from("profiles").select("display_name, line_user_id").eq("id",f.current_profile_id).single();a=c}else{let{data:c}=await b.from("profiles").select("display_name, line_user_id").eq("user_id",d.id).maybeSingle();a=c}return console.log("getUserProfile - user.id:",d.id),console.log("getUserProfile - profile:",a),{email:d.email,name:a?.display_name||"",lineUserId:a?.line_user_id,userId:d.id}}async function j(a){let b=await (0,c.createServerClient)(),{data:{user:e},error:g}=await b.auth.getUser();if(g||!e)return{success:!1,error:"Unauthorized"};let h=(0,f.createServiceRoleClient)(),{error:i}=await h.auth.admin.updateUserById(e.id,{email:a,email_confirm:!0});return i?{success:!1,error:i.message}:((0,d.revalidatePath)("/app/me"),{success:!0})}async function k(a){let b=await (0,c.createServerClient)(),{data:{user:d},error:e}=await b.auth.getUser();if(e||!d)return{success:!1,error:"Unauthorized"};let{error:f}=await b.auth.updateUser({password:a});if(f){let a=f.message;return f.message.includes("New password should be different from the old password")&&(a="新しいパスワードは現在のパスワードと異なるものを設定してください。"),{success:!1,error:a}}return{success:!0}}async function l(){let a=await (0,c.createServerClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{error:d}=await a.from("users").delete().eq("id",b.id);if(d)throw console.error("Error deleting user account:",d),Error("Failed to delete account");await a.auth.signOut(),(0,e.redirect)("/login")}async function m(a,b){let e=await (0,c.createServerClient)(),{data:{user:g},error:h}=await e.auth.getUser();if(h||!g)return{success:!1,error:"Unauthorized"};let i=(0,f.createServiceRoleClient)(),{error:j}=await i.auth.admin.updateUserById(g.id,{email:a,password:b,email_confirm:!0,user_metadata:{email_confirmed_at:new Date().toISOString()}});if(j)return console.error("Error enabling email login:",j),{success:!1,error:j.message};let{error:k}=await e.from("users").update({primary_email:a}).eq("id",g.id);k&&console.error("Error updating primary_email:",k);let{error:l}=await e.auth.signInWithPassword({email:a,password:b});return l?(console.error("Error re-authenticating user:",l),{success:!1,error:"認証情報を更新しましたが、再ログインに失敗しました。一度ログアウトして、新しいメールアドレスとパスワードでログインしてください。"}):((0,d.revalidatePath)("/app/me"),{success:!0})}(0,a.i(13095).ensureServerEntryExports)([g,h,i,j,k,l,m]),(0,b.registerServerReference)(g,"40f26a7bc4e7d50f49148ea19333f7459af83fd254",null),(0,b.registerServerReference)(h,"00d24c6ee8f65997666852bc147673b076eab3af35",null),(0,b.registerServerReference)(i,"007f25c6aee4b8f7431a4dc0db3ff9ec3564fd41d9",null),(0,b.registerServerReference)(j,"409f2946cba878b9b7e24b1b1318c211c4fa668f4e",null),(0,b.registerServerReference)(k,"406d72d3c3349be9ee3a0d8faf4aaea221fd59aa62",null),(0,b.registerServerReference)(l,"00b26826f1f362a3a742fd822438fcf2313af78f6d",null),(0,b.registerServerReference)(m,"602701cf9b26122e06a59b45db5cd44f4aed6c9a51",null),a.s(["deleteAccount",()=>l,"enableEmailLogin",()=>m,"getUserProfile",()=>i,"signOut",()=>h,"switchProfile",()=>g,"updateUserEmail",()=>j,"updateUserPassword",()=>k])},40491,a=>{"use strict";var b=a.i(12095),c=a.i(83707);a.s([],45782),a.i(45782),a.s(["005003103cf9137765c8b83fa0bcc8d85ef626e4fa",()=>b.getSettingsData,"00642b6ba2fcfa7262834fb54abfd4a10b7fd12d56",()=>b.signOut,"007f25c6aee4b8f7431a4dc0db3ff9ec3564fd41d9",()=>c.getUserProfile,"00a3ece0f08af191db378518d182c60ae58e5644ab",()=>b.deleteStore,"00b26826f1f362a3a742fd822438fcf2313af78f6d",()=>c.deleteAccount,"00d24c6ee8f65997666852bc147673b076eab3af35",()=>c.signOut,"00d692a8991a77d14a953f671fadf7ca43ce78a0e6",()=>b.deleteStoreIcon,"401480709320f02adfc2c53fe10d5e53c5f50c595f",()=>b.uploadStoreIcon,"40341d408f028c7c9e09e5718db53f79f7665ac28c",()=>b.updateTimecardSettings,"405876b122190683f26917671ae7068209f3aa4158",()=>b.updateStore,"405c7cfb7acf03ff32fbbb80b7519d602d9c21f819",()=>b.createStore,"40627c04ddfab389b3c9a4913a69a6119f43db382a",()=>b.updateTheme,"406d72d3c3349be9ee3a0d8faf4aaea221fd59aa62",()=>c.updateUserPassword,"409f2946cba878b9b7e24b1b1318c211c4fa668f4e",()=>c.updateUserEmail,"40f26a7bc4e7d50f49148ea19333f7459af83fd254",()=>c.switchProfile,"40fa5639615fcc2f608746959cf859a32c49629715",()=>b.updateFeatureSettings,"602701cf9b26122e06a59b45db5cd44f4aed6c9a51",()=>c.enableEmailLogin],40491)}];

//# sourceMappingURL=apps_app_112cefd2._.js.map